<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frappe UI Starter</title>
  </head>
  <body>
    <div id="app"></div>

    <!-- CSRF token initialization (runs immediately on page load) -->
    <script>
      (function initFrappeAndCSRF() {
        // Helper to get cookie value
        const getCookie = (name) => {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
        };

        // Try to get CSRF token from multiple sources
        let csrfToken = '';

        // 1. Check if already set by Frappe boot
        if (window.csrf_token) {
          csrfToken = window.csrf_token;
        }
        // 2. Check cookie
        else if (getCookie('csrf_token')) {
          csrfToken = getCookie('csrf_token');
        }
        // 3. Check if frappe object exists with token
        else if (window.frappe?.csrf_token) {
          csrfToken = window.frappe.csrf_token;
        }

        // Set global CSRF token
        window.csrf_token = csrfToken;

        // Initialize minimal frappe object if not present
        if (typeof window.frappe === 'undefined') {
          window.frappe = {
            csrf_token: csrfToken,
            _messages: [],
            ready_events: [],
            ready(fn) {
              if (typeof fn === 'function') {
                fn();
              }
            },
            form: {} // Add empty form object to prevent errors
          };
        } else {
          window.frappe.csrf_token = csrfToken;
          if (!window.frappe.form) {
            window.frappe.form = {}; // Add empty form object to prevent errors
          }
        }

        console.log('[Lodgeick] Boot initialized. CSRF token:', csrfToken ? 'Available' : 'Not available');
        console.log('[Lodgeick] Cookies:', document.cookie);
      })();
    </script>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
