<template>
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between py-4">
          <div class="flex items-center space-x-3">
            <button @click="goBack" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
            </button>
            <div>
              <h1 class="text-xl font-bold text-gray-900">New Application</h1>
              <p class="text-sm text-gray-500">Step {{ currentStep }} of {{ totalSteps }}</p>
            </div>
          </div>
          <Button @click="saveDraft" variant="outline" theme="gray" :loading="savingDraft">
            Save Draft
          </Button>
        </div>
      </div>
    </header>

    <!-- Progress Bar -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between mb-2">
          <div
            v-for="(step, index) in steps"
            :key="index"
            class="flex items-center"
            :class="{ 'flex-1': index < steps.length - 1 }"
          >
            <div class="flex flex-col items-center">
              <div
                class="w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm"
                :class="getStepClass(index + 1)"
              >
                <span v-if="index + 1 < currentStep">✓</span>
                <span v-else>{{ index + 1 }}</span>
              </div>
              <span
                class="text-xs mt-2 text-center"
                :class="index + 1 === currentStep ? 'text-blue-600 font-medium' : 'text-gray-500'"
              >
                {{ step.title }}
              </span>
            </div>
            <div
              v-if="index < steps.length - 1"
              class="flex-1 h-1 mx-4 rounded"
              :class="index + 1 < currentStep ? 'bg-blue-600' : 'bg-gray-200'"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
        <!-- Step 1: Council Selection -->
        <div v-if="currentStep === 1">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Select Council</h2>
          <p class="text-gray-600 mb-8">Choose the council that will process your application</p>

          <CouncilSelector
            v-model="formData.council"
            @change="onCouncilChange"
            display-mode="cards"
            :required="true"
            :show-selected-info="true"
            label=""
            :show-label="false"
          />
        </div>

        <!-- Step 2: Request Type -->
        <div v-if="currentStep === 2">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Select Application Type</h2>
          <p class="text-gray-600 mb-8">Choose the type of consent you wish to apply for</p>

          <div v-if="requestTypes.loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          </div>

          <div v-else class="grid md:grid-cols-2 gap-4">
            <div
              v-for="type in requestTypes.data"
              :key="type.name"
              @click="selectRequestType(type)"
              class="border-2 rounded-lg p-6 cursor-pointer transition-all hover:shadow-md"
              :class="formData.request_type === type.name ? 'border-blue-600 bg-blue-50' : 'border-gray-200 hover:border-blue-300'"
            >
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ type.type_name }}</h3>
                  <p class="text-sm text-gray-600" v-html="type.description || 'No description available'"></p>
                  <div class="mt-4 flex items-center space-x-4 text-xs text-gray-500">
                    <span v-if="type.base_fee">Fee: ${{ type.base_fee }}</span>
                    <span v-if="type.processing_sla_days">{{ type.processing_sla_days }} days</span>
                    <span v-if="type.category" class="px-2 py-1 bg-gray-100 rounded">{{ type.category }}</span>
                  </div>
                </div>
                <div v-if="formData.request_type === type.name" class="ml-4">
                  <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Property Details -->
        <div v-if="currentStep === 3">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Property Details</h2>
          <p class="text-gray-600 mb-8">Provide details about the property for this application</p>

          <div class="space-y-6">
            <!-- Property Search/Select -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Select Existing Property or Enter New
              </label>
              <select
                v-model="formData.property"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                @change="onPropertySelect"
              >
                <option value="">-- Select a property or enter new --</option>
                <option v-for="prop in properties.data" :key="prop.name" :value="prop.name">
                  {{ prop.property_id }} - {{ prop.street_address }}, {{ prop.suburb }}
                </option>
              </select>
            </div>

            <!-- Acting on Behalf Section -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <div class="mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Who is this application for?</h3>
                <div class="space-y-3">
                  <label class="flex items-start space-x-3 cursor-pointer">
                    <input
                      type="radio"
                      :value="false"
                      v-model="formData.acting_on_behalf"
                      class="mt-1"
                    />
                    <div>
                      <div class="font-medium text-gray-900">This application is for myself</div>
                      <div class="text-sm text-gray-500">I am the applicant submitting this request</div>
                    </div>
                  </label>
                  <label class="flex items-start space-x-3 cursor-pointer">
                    <input
                      type="radio"
                      :value="true"
                      v-model="formData.acting_on_behalf"
                      class="mt-1"
                    />
                    <div>
                      <div class="font-medium text-gray-900">I am acting on behalf of a client</div>
                      <div class="text-sm text-gray-500">I am an agent submitting this request for someone else</div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Applicant Contact Details (Required) -->
              <div>
                <h3 class="text-sm font-semibold text-gray-900 mb-4">
                  {{ formData.acting_on_behalf ? 'Client Information *' : 'Applicant Contact Information *' }}
                </h3>

                <div class="space-y-4">
                  <div class="grid md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                      <input
                        v-model="formData.applicant_name"
                        type="text"
                        placeholder="John Smith"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        :disabled="!formData.acting_on_behalf && userProfile"
                        required
                      />
                      <p v-if="!formData.acting_on_behalf" class="mt-1 text-xs text-gray-500">Auto-populated from your profile</p>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                      <input
                        v-model="formData.applicant_email"
                        type="email"
                        placeholder="john@example.com"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        :disabled="!formData.acting_on_behalf && userProfile"
                        required
                      />
                      <p v-if="!formData.acting_on_behalf" class="mt-1 text-xs text-gray-500">Auto-populated from your profile</p>
                    </div>
                  </div>

                  <div class="grid md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Contact Phone *</label>
                      <input
                        v-model="formData.applicant_phone"
                        type="tel"
                        placeholder="021 123 4567"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        required
                      />
                      <p class="mt-1 text-xs text-gray-500">
                        {{ formData.acting_on_behalf ? 'Required for application processing' : 'Will be saved to your profile for future applications' }}
                      </p>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Applicant Type *</label>
                      <select
                        v-model="formData.applicant_type"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        required
                      >
                        <option value="">Select applicant type</option>
                        <option value="Individual">Individual</option>
                        <option value="Company">Company</option>
                        <option value="Trust">Trust</option>
                        <option value="Partnership">Partnership</option>
                        <option value="Other">Other</option>
                      </select>
                      <p class="mt-1 text-xs text-gray-500">Type of entity making this application</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Manual Property Entry -->
            <div v-if="!formData.property" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Property Address *</label>
                <input
                    v-model="formData.property_address"
                    type="text"
                    placeholder="123 Main Street, Wellington"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Legal Description</label>
                  <input
                    v-model="formData.legal_description"
                    type="text"
                    placeholder="Lot 1 DP 12345"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Valuation Reference</label>
                  <input
                    v-model="formData.valuation_reference"
                    type="text"
                    placeholder="1234567"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Zone</label>
                <select
                  v-model="formData.zone"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Select zone</option>
                  <option value="Residential">Residential</option>
                  <option value="Commercial">Commercial</option>
                  <option value="Industrial">Industrial</option>
                  <option value="Rural">Rural</option>
                  <option value="Mixed Use">Mixed Use</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: RC Details (Resource Consent) OR Additional Information (Other Requests) -->
        <div v-if="currentStep === 4">
          <!-- Resource Consent: RC Details -->
          <div v-if="isResourceConsent">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Resource Consent Details</h2>
            <p class="text-gray-600 mb-8">Provide Resource Management Act (RMA) specific information</p>
          </div>

          <!-- Non-Resource Consent: Additional Information with File Upload -->
          <div v-else>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Additional Information</h2>
            <p class="text-gray-600 mb-8">Provide details about your request and attach any supporting documents</p>

            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Brief Description *</label>
                <input
                  v-model="formData.brief_description"
                  type="text"
                  placeholder="e.g., Request for LIM report on property"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Additional Details</label>
                <textarea
                  v-model="formData.detailed_description"
                  rows="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Provide any additional information relevant to your request..."
                ></textarea>
              </div>

              <!-- File Upload Section -->
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                <div class="text-center">
                  <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                  <div class="mt-4">
                    <label class="cursor-pointer">
                      <span class="px-4 py-2 bg-white text-sm font-medium text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50">
                        Choose Files
                      </span>
                      <input
                        ref="fileInput"
                        type="file"
                        multiple
                        @change="handleFileUpload"
                        class="hidden"
                      />
                    </label>
                  </div>
                  <p class="mt-2 text-xs text-gray-500">
                    Upload any supporting documents (optional)
                  </p>
                </div>

                <!-- Uploaded Files List -->
                <div v-if="uploadedFiles.length > 0" class="mt-4 space-y-2">
                  <div v-for="(file, index) in uploadedFiles" :key="index" class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <div class="flex items-center space-x-2">
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <span class="text-sm text-gray-700">{{ file.name }}</span>
                      <span class="text-xs text-gray-500">({{ formatFileSize(file.size) }})</span>
                    </div>
                    <button @click="removeFile(index)" type="button" class="text-red-600 hover:text-red-800">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5 content moved to Step 4 - this section will be deleted -->
        <div v-if="false">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Resource Consent Details</h2>
          <p class="text-gray-600 mb-8">Provide Resource Management Act (RMA) specific information</p>

          <div class="space-y-6">
            <!-- Reference and Delivery -->
            <div class="grid md:grid-cols-3 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Applicant Reference Number
                </label>
                <input
                  v-model="formData.applicant_reference_number"
                  type="text"
                  placeholder="e.g., PROJ-2025-001"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <p class="mt-1 text-xs text-gray-500">Your internal project/file reference (optional)</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  PIM Reference
                </label>
                <input
                  v-model="formData.pim_reference"
                  type="text"
                  placeholder="e.g., PIM-2024-12345"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <p class="mt-1 text-xs text-gray-500">Property Information Memorandum number (if applicable)</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Delivery Preference
                </label>
                <select
                  v-model="formData.delivery_preference"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Select preference</option>
                  <option value="Email">Email</option>
                  <option value="Postal Mail">Postal Mail</option>
                  <option value="Both Email and Postal">Both Email and Postal</option>
                </select>
                <p class="mt-1 text-xs text-gray-500">How to receive correspondence</p>
              </div>
            </div>

            <!-- Consent Types and Activity Status -->
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Consent Type(s) *
                </label>
                <div class="space-y-2 p-3 border border-gray-300 rounded-lg">
                  <label v-for="consentType in availableConsentTypes" :key="consentType" class="flex items-center">
                    <input
                      type="checkbox"
                      :value="consentType"
                      @change="toggleConsentType(consentType)"
                      :checked="isConsentTypeSelected(consentType)"
                      class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    />
                    <span class="ml-2 text-sm text-gray-700">{{ consentType }}</span>
                  </label>
                </div>
                <p class="mt-1 text-xs text-gray-500">Select all consent types required (multiple allowed)</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Activity Status *
                  <button
                    type="button"
                    @click="showActivityStatusHelp = !showActivityStatusHelp"
                    class="ml-1 text-blue-600 hover:text-blue-800"
                    title="Click for help"
                  >
                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </button>
                </label>

                <div v-if="showActivityStatusHelp" class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-900">
                  <p class="font-semibold mb-2">RMA Activity Status Guide:</p>
                  <ul class="space-y-1 ml-4 list-disc">
                    <li><strong>Permitted:</strong> Allowed without consent (no application needed)</li>
                    <li><strong>Controlled:</strong> Consent must be granted; council sets conditions</li>
                    <li><strong>Restricted Discretionary:</strong> Council has limited grounds to decline</li>
                    <li><strong>Discretionary:</strong> Council has full discretion to grant or decline</li>
                    <li><strong>Non-Complying:</strong> Does not comply with plan; requires special justification</li>
                    <li><strong>Prohibited:</strong> Cannot be consented under any circumstances</li>
                  </ul>
                  <p class="mt-2 text-xs text-blue-700">Check your district plan zone rules to determine status</p>
                </div>

                <select
                  v-model="formData.activity_status"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  required
                >
                  <option value="">Select activity status</option>
                  <option value="Controlled">Controlled</option>
                  <option value="Restricted Discretionary">Restricted Discretionary</option>
                  <option value="Discretionary">Discretionary</option>
                  <option value="Non-Complying">Non-Complying</option>
                  <option value="Permitted Boundary Activity">Permitted Boundary Activity</option>
                </select>
                <p class="mt-1 text-xs text-gray-500">Activity classification under district plan</p>

                <div v-if="activityStatusWarning" class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                  {{ activityStatusWarning }}
                </div>
              </div>
            </div>

            <!-- Permitted Boundary Activity (RMA s87BA) -->
            <div v-if="formData.activity_status === 'Permitted Boundary Activity'" class="border-t border-gray-200 pt-6 mt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-2">Permitted Boundary Activity (RMA s87BA)</h3>
              <p class="text-xs text-gray-500 mb-4">This is a special consent type for boundary infringements under section 87BA of the Resource Management Act</p>

              <div class="space-y-4">
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Boundary Description</label>
                  <input
                    v-model="formData.boundary_description"
                    type="text"
                    placeholder="e.g., Side boundary with 123 Main Street"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                  />
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Description of Boundary Activity</label>
                  <textarea
                    v-model="formData.boundary_activity_description"
                    rows="3"
                    placeholder="Describe how the activity infringes the boundary setback requirements..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                  ></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <div class="flex items-start mb-2">
                      <input
                        type="checkbox"
                        v-model="formData.boundary_owner_approval_obtained"
                        class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <label class="ml-3 text-xs font-medium text-gray-700">
                        Affected boundary owner approval obtained
                      </label>
                    </div>
                  </div>

                  <div v-if="formData.boundary_owner_approval_obtained">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Approval Date</label>
                    <input
                      v-model="formData.boundary_approval_date"
                      type="date"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                    />
                  </div>
                </div>

                <div v-if="formData.boundary_owner_approval_obtained">
                  <label class="block text-xs font-medium text-gray-700 mb-1">Approval Documentation</label>
                  <input
                    type="file"
                    @change="handleBoundaryApprovalUpload"
                    accept=".pdf,.doc,.docx,.jpg,.png"
                    class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"
                  />
                  <p v-if="formData.boundary_approval_document" class="text-xs text-blue-600 mt-1">
                    ✓ Document uploaded
                  </p>
                </div>
              </div>
            </div>

            <!-- Proposal Details -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-4">Proposal Details</h3>
              <p class="text-xs text-gray-500 mb-4">Provide details about your proposed development (all fields optional)</p>

              <!-- Building/Structure Details -->
              <div class="mb-4">
                <h4 class="text-xs font-medium text-gray-700 mb-3">Building/Structure Dimensions</h4>
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Building Height (metres)</label>
                    <input
                    v-model="formData.building_height"
                    type="number"
                    placeholder="e.g., 8.5"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Total Floor Area (m²)</label>
                    <input
                    v-model="formData.building_floor_area"
                    type="number"
                    placeholder="e.g., 250"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                  </div>
                </div>
              </div>

              <!-- Earthworks -->
              <div class="mb-4">
                <h4 class="text-xs font-medium text-gray-700 mb-3">Earthworks</h4>
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Earthworks Volume (m³)</label>
                    <input
                    v-model="formData.earthworks_volume"
                    type="number"
                    placeholder="e.g., 150"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Maximum Vertical Alteration (metres)</label>
                    <input
                    v-model="formData.earthworks_vertical_alteration"
                    type="number"
                    placeholder="e.g., 2.5"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                  </div>
                </div>
              </div>

              <!-- Traffic & Operations -->
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <h4 class="text-xs font-medium text-gray-700 mb-3">Traffic & Parking</h4>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs font-medium text-gray-600 mb-1">Additional Vehicle Movements/Day</label>
                      <input
                    v-model="formData.vehicle_movements_daily"
                    type="number"
                    placeholder="e.g., 20"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-600 mb-1">Parking Spaces Provided</label>
                      <input
                    v-model="formData.parking_spaces_provided"
                    type="number"
                    placeholder="e.g., 4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                    </div>
                  </div>
                </div>
                <div>
                  <h4 class="text-xs font-medium text-gray-700 mb-3">Operations</h4>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs font-medium text-gray-600 mb-1">Hours of Operation</label>
                      <input
                    v-model="formData.hours_of_operation"
                    type="text"
                    placeholder="e.g., Mon-Fri 8am-6pm"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-600 mb-1">Consent Term Requested</label>
                      <input
                    v-model="formData.consent_term_requested"
                    type="text"
                    placeholder="e.g., 5 years, Unlimited"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Site & Environment -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-4">Site & Environment</h3>
              <p class="text-xs text-gray-500 mb-4">Describe existing site conditions and environmental features (all fields optional)</p>

              <div class="space-y-4">
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Site Topography</label>
                  <textarea
                    v-model="formData.site_topography"
                    rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="e.g., Generally flat with gentle slope to north, approximately 10m elevation..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Existing Vegetation</label>
                  <textarea
                    v-model="formData.existing_vegetation_description"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Describe existing trees, shrubs, native vegetation, notable specimens..."
                  ></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <div class="flex items-start mb-2">
                      <input
                        type="checkbox"
                        v-model="formData.watercourses_present"
                        class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <label class="ml-3 text-xs font-medium text-gray-700">
                        Watercourses/Wetlands Present on Site
                      </label>
                    </div>
                    <div v-if="formData.watercourses_present">
                      <textarea
                        v-model="formData.watercourse_description"
                        rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="Describe watercourses, streams, wetlands..."
                      ></textarea>
                    </div>
                  </div>

                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">HAIL Contamination Status</label>
                    <select
                      v-model="formData.contamination_status_hail"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    >
                      <option value="">Select contamination status</option>
                      <option value="Not Assessed">Not Assessed</option>
                      <option value="Not HAIL">Not HAIL (Hazardous Activities and Industries List)</option>
                      <option value="HAIL - Not Investigated">HAIL - Not Investigated</option>
                      <option value="HAIL - Investigated (Clean)">HAIL - Investigated (Clean)</option>
                      <option value="HAIL - Contaminated">HAIL - Contaminated</option>
                    </select>
                  </div>
                </div>

                <!-- Natural Hazards Assessment (RMA s104) -->
                <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                  <h4 class="text-sm font-semibold text-blue-900 mb-3">Natural Hazards Assessment (RMA s104)</h4>
                  <p class="text-xs text-blue-700 mb-3">Indicate which natural hazards are present on or near the site</p>

                  <div class="space-y-2 mb-3">
                    <div v-for="hazard in naturalHazardTypes" :key="hazard" class="flex items-center">
                      <input
                        type="checkbox"
                        :id="'hazard-' + hazard"
                        :value="hazard"
                        v-model="selectedHazards"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <label :for="'hazard-' + hazard" class="ml-2 text-sm text-gray-700">{{ hazard }}</label>
                    </div>
                  </div>

                  <div v-if="selectedHazards.length > 0" class="border-t border-blue-300 pt-3 mt-3">
                    <div v-for="hazard in selectedHazards" :key="hazard" class="mb-4 last:mb-0">
                      <h5 class="text-xs font-semibold text-blue-900 mb-2">{{ hazard }}</h5>
                      <div class="grid md:grid-cols-2 gap-3">
                        <div>
                          <label class="block text-xs font-medium text-gray-700 mb-1">Risk Level</label>
                          <select
                            v-model="getHazardData(hazard).risk_level"
                            class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-white"
                          >
                            <option value="">Select risk level</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Extreme">Extreme</option>
                          </select>
                        </div>
                        <div class="flex items-end">
                          <div class="flex items-center mb-1">
                            <input
                              type="checkbox"
                              :id="'mitigation-' + hazard"
                              v-model="getHazardData(hazard).mitigation_required"
                              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            />
                            <label :for="'mitigation-' + hazard" class="ml-2 text-xs text-gray-700">Mitigation Required</label>
                          </div>
                        </div>
                      </div>
                      <div class="mt-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Assessment Notes</label>
                        <textarea
                          v-model="getHazardData(hazard).assessment_notes"
                          rows="2"
                          class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-white"
                          placeholder="Describe the hazard and its potential impact..."
                        ></textarea>
                      </div>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Existing Infrastructure</label>
                  <textarea
                    v-model="formData.existing_infrastructure"
                    rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="e.g., Wastewater, stormwater, electricity connections..."
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- National Environmental Standards (NES) Assessment -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-2">National Environmental Standards (NES) Assessment</h3>
              <p class="text-xs text-gray-500 mb-4">Indicate which National Environmental Standards apply to this proposal</p>

              <!-- Context Summary Panel -->
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h4 class="text-sm font-semibold text-blue-900 mb-2">Application Context</h4>
                <div class="grid md:grid-cols-2 gap-3 text-xs">
                  <div>
                    <span class="font-medium text-blue-800">Applicant:</span>
                    <span class="text-blue-700 ml-1">{{ formData.applicant_name || 'Not provided' }}</span>
                  </div>
                  <div>
                    <span class="font-medium text-blue-800">Location:</span>
                    <span class="text-blue-700 ml-1">{{ formData.property_address || 'Not provided' }}</span>
                  </div>
                  <div>
                    <span class="font-medium text-blue-800">Consent Type(s):</span>
                    <span class="text-blue-700 ml-1">{{ formData.consent_types.map(ct => ct.consent_type).join(', ') || 'Not selected' }}</span>
                  </div>
                  <div>
                    <span class="font-medium text-blue-800">Activity Status:</span>
                    <span class="text-blue-700 ml-1">{{ formData.activity_status || 'Not selected' }}</span>
                  </div>
                </div>
              </div>

              <div class="space-y-3">
                <div v-for="nesType in nesTypes" :key="nesType.value" class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                  <div class="flex items-start mb-2">
                    <input
                      type="checkbox"
                      :id="'nes-' + nesType.value"
                      v-model="getNESData(nesType.value).applies"
                      class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    />
                    <label :for="'nes-' + nesType.value" class="ml-3 text-sm font-medium text-gray-900">
                      {{ nesType.label }}
                    </label>
                  </div>

                  <div v-if="getNESData(nesType.value).applies" class="ml-7 mt-3 space-y-3 border-l-2 border-blue-300 pl-3">
                    <!-- Other NES Description (conditional) -->
                    <div v-if="nesType.value === 'Other'">
                      <label class="block text-xs font-medium text-gray-700 mb-1">Other NES Description *</label>
                      <input
                        v-model="getNESData(nesType.value).other_nes_description"
                        type="text"
                        required
                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-white"
                        placeholder="Please specify the NES type..."
                      />
                    </div>

                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Compliance Status</label>
                      <select
                        v-model="getNESData(nesType.value).compliance_status"
                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-white"
                      >
                        <option value="">Select compliance status</option>
                        <option value="Permitted Activity">Permitted Activity</option>
                        <option value="Requires Consent">Requires Consent</option>
                        <option value="Non-Complying Activity">Non-Complying Activity</option>
                      </select>
                    </div>

                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Assessment Notes</label>
                      <textarea
                        v-model="getNESData(nesType.value).assessment_notes"
                        rows="2"
                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-white"
                        placeholder="Provide details on how the NES applies..."
                      ></textarea>
                    </div>

                    <!-- In-context NES Document Upload -->
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Upload NES Assessment Document</label>
                      <div class="flex items-center gap-2">
                        <input
                          type="file"
                          @change="handleNESDocumentUpload($event, nesType.value)"
                          accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                          class="text-xs file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        />
                      </div>
                      <p class="text-xs text-gray-500 mt-1">PDF, Word documents, or images (max 10MB)</p>
                      <!-- Show uploaded NES documents for this type -->
                      <div v-if="getNESDocuments(nesType.value).length > 0" class="mt-2 space-y-1">
                        <div v-for="(doc, docIdx) in getNESDocuments(nesType.value)" :key="docIdx" class="flex items-center justify-between text-xs bg-gray-50 p-2 rounded">
                          <span class="text-gray-700">{{ doc.document_type }} - {{ doc.file?.name || 'Uploaded' }}</span>
                          <button
                            @click="removeNESDocument(nesType.value, docIdx)"
                            type="button"
                            class="text-red-600 hover:text-red-800"
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- HAIL Activities (Contaminated Land) -->
            <div v-if="isNESSoilsSelected" class="border-t border-gray-200 pt-6 mt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-2">HAIL Activities (Hazardous Activities and Industries List)</h3>
              <p class="text-xs text-gray-500 mb-4">For sites with potential soil contamination under the NES for Assessing and Managing Contaminants in Soil</p>

              <div class="flex items-center justify-between mb-3">
                <p class="text-xs text-gray-600">List any HAIL activities on the site (past, current, or likely)</p>
                <button
                  @click="addHAILActivity"
                  type="button"
                  class="px-3 py-1 text-xs font-medium text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200"
                >
                  + Add HAIL Activity
                </button>
              </div>

              <div v-if="formData.hail_activities.length > 0" class="space-y-3">
                <div
                  v-for="(hail, index) in formData.hail_activities"
                  :key="index"
                  class="border border-gray-300 rounded-lg p-4 bg-white"
                >
                  <div class="flex items-start justify-between mb-3">
                    <h4 class="text-sm font-medium text-gray-900">HAIL Activity #{{ index + 1 }}</h4>
                    <button
                      @click="removeHAILActivity(index)"
                      type="button"
                      class="text-red-600 hover:text-red-800"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>

                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Activity Description *</label>
                      <textarea
                        v-model="hail.activity_description"
                        rows="2"
                        required
                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                        placeholder="Describe the HAIL activity (e.g., Former service station, industrial site)..."
                      ></textarea>
                    </div>

                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">HAIL Category</label>
                      <select
                        v-model="hail.hail_category"
                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-white"
                      >
                        <option value="">Select HAIL category</option>
                        <option value="Category A - Petroleum/Oil Storage">Category A - Petroleum/Oil Storage</option>
                        <option value="Category B - Asbestos Products">Category B - Asbestos Products</option>
                        <option value="Category C - Chemicals">Category C - Chemicals</option>
                        <option value="Category D - Engineering Workshops">Category D - Engineering Workshops</option>
                        <option value="Category E - Gasworks/Coke Works">Category E - Gasworks/Coke Works</option>
                        <option value="Category F - Horticulture">Category F - Horticulture</option>
                        <option value="Category G - Landfills/Waste Disposal">Category G - Landfills/Waste Disposal</option>
                        <option value="Category H - Metal Treatment">Category H - Metal Treatment</option>
                        <option value="Category I - Timber Treatment">Category I - Timber Treatment</option>
                      </select>
                      <p class="text-xs text-gray-500 mt-1">Select the applicable HAIL category for this activity</p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-3">
                      <div class="flex items-center">
                        <input
                          type="checkbox"
                          :id="'hail-current-' + index"
                          v-model="hail.currently_undertaken"
                          class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        />
                        <label :for="'hail-current-' + index" class="ml-2 text-xs text-gray-700">Currently Being Undertaken</label>
                      </div>

                      <div class="flex items-center">
                        <input
                          type="checkbox"
                          :id="'hail-previous-' + index"
                          v-model="hail.previously_undertaken"
                          class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        />
                        <label :for="'hail-previous-' + index" class="ml-2 text-xs text-gray-700">Previously Undertaken</label>
                      </div>

                      <div class="flex items-center">
                        <input
                          type="checkbox"
                          :id="'hail-likely-' + index"
                          v-model="hail.likely_undertaken"
                          class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        />
                        <label :for="'hail-likely-' + index" class="ml-2 text-xs text-gray-700">Likely to Have Been Undertaken</label>
                      </div>
                    </div>

                    <div class="flex items-center">
                      <input
                        type="checkbox"
                        :id="'hail-investigated-' + index"
                        v-model="hail.preliminary_investigation_done"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <label :for="'hail-investigated-' + index" class="ml-2 text-xs text-gray-700">Preliminary Investigation Completed</label>
                    </div>

                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-2">Proposed Activities</label>
                      <div class="space-y-2 p-3 border border-gray-200 rounded bg-gray-50">
                        <div class="flex items-center">
                          <input
                            type="checkbox"
                            :id="'hail-activity-fuel-' + index"
                            @change="toggleHAILProposedActivity(index, 'Removing or replacing fuel storage system')"
                            :checked="isHAILActivitySelected(index, 'Removing or replacing fuel storage system')"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                          />
                          <label :for="'hail-activity-fuel-' + index" class="ml-2 text-xs text-gray-700">Removing or replacing fuel storage system</label>
                        </div>
                        <div class="flex items-center">
                          <input
                            type="checkbox"
                            :id="'hail-activity-disturb-' + index"
                            @change="toggleHAILProposedActivity(index, 'Disturbing soil')"
                            :checked="isHAILActivitySelected(index, 'Disturbing soil')"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                          />
                          <label :for="'hail-activity-disturb-' + index" class="ml-2 text-xs text-gray-700">Disturbing soil</label>
                        </div>
                        <div class="flex items-center">
                          <input
                            type="checkbox"
                            :id="'hail-activity-sample-' + index"
                            @change="toggleHAILProposedActivity(index, 'Sampling soil')"
                            :checked="isHAILActivitySelected(index, 'Sampling soil')"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                          />
                          <label :for="'hail-activity-sample-' + index" class="ml-2 text-xs text-gray-700">Sampling soil</label>
                        </div>
                        <div class="flex items-center">
                          <input
                            type="checkbox"
                            :id="'hail-activity-subdivide-' + index"
                            @change="toggleHAILProposedActivity(index, 'Subdividing land')"
                            :checked="isHAILActivitySelected(index, 'Subdividing land')"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                          />
                          <label :for="'hail-activity-subdivide-' + index" class="ml-2 text-xs text-gray-700">Subdividing land</label>
                        </div>
                        <div class="flex items-center">
                          <input
                            type="checkbox"
                            :id="'hail-activity-change-' + index"
                            @change="toggleHAILProposedActivity(index, 'Changing use of land')"
                            :checked="isHAILActivitySelected(index, 'Changing use of land')"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                          />
                          <label :for="'hail-activity-change-' + index" class="ml-2 text-xs text-gray-700">Changing use of land</label>
                        </div>
                      </div>
                      <p class="text-xs text-gray-500 mt-1">Select all proposed activities that apply (multiple allowed)</p>
                    </div>

                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                      <textarea
                        v-model="hail.notes"
                        rows="2"
                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                        placeholder="Additional notes about the HAIL activity..."
                      ></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <div v-else class="text-center py-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <p class="text-sm text-gray-500">No HAIL activities added yet</p>
                <p class="text-xs text-gray-400 mt-1">Click "Add HAIL Activity" to document contaminated land activities</p>
              </div>
            </div>

            <!-- Assessment of Environmental Effects -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Assessment of Environmental Effects (AEE) *
              </label>
              <textarea
                v-model="formData.assessment_of_effects"
                rows="8"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Describe the actual and potential effects on the environment as per Schedule 4 of the RMA. Include effects on people, physical environment, ecosystems, and cultural/heritage values..."
                required
              ></textarea>
              <p class="mt-1 text-xs text-gray-500">Required under Schedule 4 of the Resource Management Act</p>
            </div>

            <!-- Effects Breakdown (Optional) -->
            <div class="border-t border-gray-200 pt-4">
              <h3 class="text-sm font-semibold text-gray-900 mb-3">Detailed Effects Assessment (Optional)</h3>
              <p class="text-xs text-gray-500 mb-4">Break down your AEE into specific effect categories for a more comprehensive assessment</p>

              <div class="space-y-4">
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Effects on People</label>
                  <textarea
                    v-model="formData.effects_on_people"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Privacy, sunlight access, visual amenity, noise impacts..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Physical Effects</label>
                  <textarea
                    v-model="formData.physical_effects"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Traffic, parking, stormwater, infrastructure impacts..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Earthworks Effects</label>
                  <textarea
                    v-model="formData.earthworks_effects"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Soil disturbance, erosion, sediment control, slope stability, construction impacts..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Discharge/Contaminants Effects</label>
                  <textarea
                    v-model="formData.discharge_contaminants_effects"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Stormwater discharge, wastewater, air quality, dust, odour, contaminant management..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Ecosystem Effects</label>
                  <textarea
                    v-model="formData.ecosystem_effects"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Indigenous vegetation, habitat values, watercourses, biodiversity..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Hazard Risk Assessment</label>
                  <textarea
                    v-model="formData.hazard_risk_assessment"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Flood risk, liquefaction, slope instability, coastal hazards, seismic risk..."
                  ></textarea>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Cultural/Heritage Effects</label>
                  <textarea
                    v-model="formData.cultural_effects"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="Heritage values, sites of significance to Māori, archaeological sites..."
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Planning Assessment -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Planning Assessment *
              </label>
              <textarea
                v-model="formData.planning_assessment"
                rows="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Assess the proposal against relevant district plan provisions, objectives and policies. Address how the proposal aligns with planning framework..."
                required
              ></textarea>
              <p class="mt-1 text-xs text-gray-500">Assessment against district plan objectives and policies</p>
            </div>

            <!-- RMA Part 2 Assessment -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                RMA Part 2 Assessment
              </label>
              <textarea
                v-model="formData.rma_part2_assessment"
                rows="5"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Assess the proposal against Part 2 of the RMA, including sections 5 (Purpose), 6 (Matters of national importance), 7 (Other matters), and 8 (Treaty of Waitangi)..."
              ></textarea>
              <p class="mt-1 text-xs text-gray-500">Assessment against RMA Part 2 principles (sections 5-8)</p>
            </div>

            <!-- Alternatives and Mitigation -->
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Alternatives Considered
                </label>
                <textarea
                  v-model="formData.alternatives_considered"
                  rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  placeholder="What alternative designs, locations, or methods were considered?..."
                ></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Mitigation Measures
                </label>
                <textarea
                  v-model="formData.mitigation_proposed"
                  rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  placeholder="What measures will be implemented to avoid, remedy or mitigate adverse effects?..."
                ></textarea>
              </div>
            </div>

            <!-- Affected Parties -->
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-900">Affected Parties</h3>
                <Button @click="addAffectedParty" variant="outline" theme="blue" size="sm">
                  <template #prefix>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                  </template>
                  Add Party
                </Button>
              </div>

              <p class="text-xs text-gray-500 mb-3">
                List any parties (neighbors, landowners, etc.) who may be adversely affected by the proposal
              </p>

              <div v-if="formData.affected_parties.length > 0" class="space-y-3 mb-3">
                <div
                  v-for="(party, index) in formData.affected_parties"
                  :key="index"
                  class="p-4 bg-white rounded-lg border border-gray-300 hover:border-blue-400 transition-colors"
                >
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-2">
                        <h4 class="text-sm font-semibold text-gray-900">{{ party.party_name }}</h4>
                        <span class="px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded">
                          {{ party.relationship }}
                        </span>
                      </div>

                      <div class="grid md:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                        <div v-if="party.property_address" class="flex items-start gap-1">
                          <svg class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                          </svg>
                          <span>{{ party.property_address }}</span>
                        </div>

                        <div v-if="party.email" class="flex items-center gap-1">
                          <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                          </svg>
                          <a :href="'mailto:' + party.email" class="text-blue-600 hover:underline">{{ party.email }}</a>
                        </div>

                        <div v-if="party.phone" class="flex items-center gap-1">
                          <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                          </svg>
                          <a :href="'tel:' + party.phone" class="text-blue-600 hover:underline">{{ party.phone }}</a>
                        </div>

                        <div v-if="party.postal_address" class="flex items-start gap-1">
                          <svg class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 19v-8.93a2 2 0 01.89-1.664l7-4.666a2 2 0 012.22 0l7 4.666A2 2 0 0121 10.07V19M3 19a2 2 0 002 2h14a2 2 0 002-2M3 19l6.75-4.5M21 19l-6.75-4.5M3 10l6.75 4.5M21 10l-6.75 4.5m0 0l-1.14.76a2 2 0 01-2.22 0l-1.14-.76" />
                          </svg>
                          <span>Postal: {{ party.postal_address }}</span>
                        </div>
                      </div>

                      <div v-if="party.approval_obtained" class="mt-2 flex items-center gap-2">
                        <span class="inline-flex items-center gap-1 text-xs text-green-700 bg-green-50 px-2 py-1 rounded">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                          </svg>
                          Written approval obtained
                        </span>
                        <span v-if="party.approval_date" class="text-xs text-gray-500">{{ party.approval_date }}</span>
                      </div>

                      <p v-if="party.comments" class="mt-2 text-xs text-gray-600 italic">{{ party.comments }}</p>
                    </div>

                    <div class="flex gap-1 ml-3">
                      <button
                        @click="editAffectedParty(index)"
                        class="p-1 text-blue-600 hover:bg-blue-50 rounded"
                        title="Edit party"
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </button>
                      <button
                        @click="removeAffectedParty(index)"
                        class="p-1 text-red-600 hover:bg-red-50 rounded"
                        title="Remove party"
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div v-else class="text-center py-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <p class="text-sm text-gray-500">No affected parties added yet</p>
              </div>

              <!-- Written Approvals Count -->
              <div v-if="formData.affected_parties.length > 0" class="mt-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Number of Written Approvals Obtained
                </label>
                <input
                  v-model.number="formData.written_approvals_obtained"
                  type="number"
                  min="0"
                  :max="formData.affected_parties.length"
                  class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <p class="mt-1 text-xs text-gray-500">
                  How many of the {{ formData.affected_parties.length }} affected parties have provided written approval?
                </p>
              </div>

              <!-- Iwi Consultation Note -->
              <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <h4 class="text-sm font-semibold text-green-900">Treaty of Waitangi Obligations</h4>
                    <p class="text-xs text-green-700 mt-1">
                      To record iwi/hapū consultation, add them as affected parties above using the relationship type "Iwi".
                      Include their response in the comments field. Upload any Cultural Impact Assessment (CIA) as a specialist report.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Iwi Consultation (Dedicated Section) -->
            <div class="border-t border-gray-200 pt-4">
              <h3 class="text-sm font-semibold text-gray-900 mb-3">Iwi Consultation</h3>
              <p class="text-xs text-gray-500 mb-4">
                Details of consultation with iwi and hapū under RMA s8 (Treaty of Waitangi)
              </p>

              <div class="space-y-4">
                <!-- Consultation Undertaken -->
                <div class="flex items-center">
                  <input
                    v-model="formData.iwi_consultation_undertaken"
                    type="checkbox"
                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  <label class="ml-2 text-sm text-gray-700">
                    Iwi/Hapū consultation has been undertaken
                  </label>
                </div>

                <!-- Iwi Consulted -->
                <div v-if="formData.iwi_consultation_undertaken">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Iwi/Hapū Consulted
                  </label>
                  <textarea
                    v-model="formData.iwi_consulted"
                    rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                    placeholder="List the iwi and hapū groups that were consulted..."
                  ></textarea>
                </div>

                <!-- Response Summary -->
                <div v-if="formData.iwi_consultation_undertaken">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Response Summary
                  </label>
                  <textarea
                    v-model="formData.iwi_response_summary"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                    placeholder="Summarize the responses received from iwi/hapū, including any concerns raised and how they are addressed..."
                  ></textarea>
                  <p class="mt-1 text-xs text-gray-500">
                    Summary of feedback and responses from consulted iwi/hapū
                  </p>
                </div>
              </div>
            </div>

            <!-- Specialist Reports -->
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-900">Specialist Reports</h3>
                <Button @click="addSpecialistReport" variant="outline" theme="blue" size="sm">
                  <template #prefix>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                  </template>
                  Add Report
                </Button>
              </div>

              <p class="text-xs text-gray-500 mb-3">
                Add any specialist technical reports (traffic, geotechnical, acoustic, ecological, etc.)
              </p>

              <div v-if="formData.specialist_reports.length > 0" class="space-y-3 mb-3">
                <div
                  v-for="(report, index) in formData.specialist_reports"
                  :key="index"
                  class="p-4 bg-white rounded-lg border border-gray-300 hover:border-blue-400 transition-colors"
                >
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <h4 class="text-sm font-semibold text-gray-900">{{ report.report_type }}</h4>
                    </div>
                    <span class="px-2 py-0.5 text-xs bg-purple-100 text-purple-700 rounded font-medium">
                      {{ report.report_date }}
                    </span>
                  </div>

                  <div class="space-y-2 text-xs text-gray-600 mb-3">
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                      <span class="font-medium">{{ report.specialist_name }}</span>
                      <span v-if="report.specialist_company" class="text-gray-400">• {{ report.specialist_company }}</span>
                    </div>

                    <div v-if="report.document" class="flex items-center gap-2 text-blue-600">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                      </svg>
                      <span>{{ typeof report.document === 'object' ? report.document.name : 'Document attached' }}</span>
                    </div>

                    <div v-if="report.summary" class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-700">
                      <span class="font-medium">Summary: </span>{{ report.summary }}
                    </div>
                  </div>

                  <div class="flex gap-2">
                    <button
                      @click="editSpecialistReport(index)"
                      class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded transition-colors"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                      Edit
                    </button>
                    <button
                      @click="removeSpecialistReport(index)"
                      class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded transition-colors"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      Remove
                    </button>
                  </div>
                </div>
              </div>

              <div v-else class="text-center py-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <p class="text-sm text-gray-500">No specialist reports added yet</p>
                <p class="text-xs text-gray-400 mt-1">Upload report files in the Documents step</p>
              </div>
            </div>

            <!-- Proposed Conditions -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <div>
                  <label class="block text-sm font-medium text-gray-700">
                    Proposed Conditions (Optional)
                  </label>
                  <p class="mt-1 text-xs text-gray-500">Select from standard templates or propose custom conditions</p>
                </div>
                <button
                  type="button"
                  @click="openConditionsModal"
                  class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 flex items-center gap-1.5"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  Browse Templates
                </button>
              </div>

              <!-- Selected Conditions Display -->
              <div v-if="formData.proposed_conditions && formData.proposed_conditions.length > 0" class="space-y-3 mt-3">
                <div v-for="(condition, index) in formData.proposed_conditions" :key="index" class="p-3 bg-white rounded-lg border border-gray-300 hover:border-blue-400 transition-colors">
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="px-2 py-0.5 bg-gray-100 text-gray-700 text-xs font-mono rounded">{{ condition.condition_number }}</span>
                      <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded">{{ condition.condition_category }}</span>
                    </div>
                    <div class="flex gap-1">
                      <button type="button" @click="editCondition(index)" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Edit condition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </button>
                      <button type="button" @click="removeCondition(index)" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Remove condition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="text-xs text-gray-700" v-html="condition.condition_text"></div>
                  <div v-if="condition.compliance_notes" class="mt-2 text-xs text-gray-500 italic">{{ condition.compliance_notes }}</div>
                </div>
              </div>

              <div v-else class="text-center py-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="text-sm text-gray-500">No conditions proposed yet</p>
                <p class="text-xs text-gray-400 mt-1">Click "Browse Templates" to select standard conditions</p>
              </div>

              <p class="mt-2 text-xs text-gray-500">
                <svg class="w-3.5 h-3.5 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                The council will determine final consent conditions based on the assessment
              </p>
            </div>

            <!-- Confidential Information (RMA s42) -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-2">Confidential Information (RMA s42)</h3>
              <p class="text-xs text-gray-500 mb-4">Under section 42 of the RMA, you may request that certain information be kept confidential if it contains trade secrets or is commercially sensitive</p>

              <div class="space-y-4">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    v-model="formData.confidential_information_claimed"
                    class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <label class="ml-3 text-sm font-medium text-gray-700">
                    This application contains confidential information that should be withheld from public notification
                  </label>
                </div>

                <div v-if="formData.confidential_information_claimed" class="ml-7 border-l-2 border-yellow-300 pl-4 bg-yellow-50 p-4 rounded-r-lg">
                  <label class="block text-sm font-medium text-gray-900 mb-2">
                    Justification for Confidentiality *
                  </label>
                  <p class="text-xs text-gray-600 mb-3">
                    Explain why this information should be withheld under s42 of the RMA. You must demonstrate that the information is a trade secret or that making it public would unreasonably prejudice your commercial position.
                  </p>
                  <textarea
                    v-model="formData.confidential_information_reason"
                    rows="4"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white"
                    placeholder="Provide detailed justification for why this information should be kept confidential. Include references to specific documents or sections that contain confidential material..."
                  ></textarea>
                  <p class="mt-2 text-xs text-yellow-700">
                    ⚠ Note: The consent authority will determine whether your justification meets the requirements of s42. Confidentiality is not guaranteed.
                  </p>
                </div>
              </div>
            </div>

            <!-- Pre-Application Meeting -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <div class="flex items-start">
                  <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                  <div class="ml-3 flex-1">
                    <h3 class="text-sm font-semibold text-blue-900 mb-2">
                      Need Help with Your Application?
                    </h3>
                    <p class="text-sm text-blue-800 mb-3">
                      For <strong>discretionary</strong> or <strong>non-complying</strong> activities, we recommend booking a pre-application meeting with our planning team. This can help:
                    </p>
                    <ul class="text-sm text-blue-800 space-y-1 ml-4 list-disc mb-4">
                      <li>Clarify district plan requirements</li>
                      <li>Identify potential issues early</li>
                      <li>Understand what information you'll need</li>
                      <li>Get preliminary feedback on your proposal</li>
                    </ul>
                    <Button
                      @click="requestPreAppMeeting"
                      variant="solid"
                      theme="blue"
                      size="sm"
                      :loading="requestingMeeting"
                    >
                      <template #prefix>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      </template>
                      Request Pre-Application Meeting
                    </Button>
                    <p class="text-xs text-blue-700 mt-2">
                      A planning officer will contact you within 2 business days to schedule.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6: Documents removed as requested -->
        <div v-if="false">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Upload Documents</h2>
          <p class="text-gray-600 mb-8">Attach all required supporting documents for Resource Consent</p>

          <div class="space-y-6">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition">
              <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p class="text-gray-600 mb-2">Drag and drop files here, or click to browse</p>
              <p class="text-xs text-gray-500">PDF, DOC, DOCX, JPG, PNG (Max 10MB per file)</p>
              <Button @click="triggerFileUpload" variant="outline" theme="blue" class="mt-4">
                Select Files
              </Button>
              <input type="file" ref="fileInput" multiple class="hidden" @change="handleFileUpload" />
            </div>

            <!-- Uploaded Files List -->
            <div v-if="uploadedFiles.length > 0" class="space-y-2">
              <h4 class="font-medium text-gray-900">Uploaded Documents ({{ uploadedFiles.length }})</h4>
              <div
                v-for="(file, index) in uploadedFiles"
                :key="index"
                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200"
              >
                <div class="flex items-center space-x-3">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <div>
                    <p class="text-sm font-medium text-gray-900">{{ file.name }}</p>
                    <p class="text-xs text-gray-500">{{ formatFileSize(file.size) }}</p>
                  </div>
                </div>
                <button @click="removeFile(index)" class="text-red-600 hover:text-red-800">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <!-- Required Documents Checklist -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h4 class="font-medium text-blue-900 mb-3">Required Documents</h4>
              <ul class="space-y-2 text-sm text-blue-800">
                <li class="flex items-start">
                  <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  Site plans and location maps
                </li>
                <li class="flex items-start">
                  <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  Architectural drawings and specifications
                </li>
                <li class="flex items-start">
                  <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  Assessment of Environmental Effects (AEE)
                </li>
                <li class="flex items-start">
                  <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  Written approvals from affected parties (if required)
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Review Step (Last Step - always step 5) -->
        <div v-if="currentStep === 5">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Review & Submit</h2>
          <p class="text-gray-600 mb-8">Please review your application before submission</p>

          <div class="space-y-6">
            <!-- Application Summary -->
            <div class="border border-gray-200 rounded-lg p-6">
              <h3 class="font-semibold text-gray-900 mb-4">Application Summary</h3>

              <dl class="grid md:grid-cols-2 gap-4 text-sm">
                <div>
                  <dt class="text-gray-600">Application Type</dt>
                  <dd class="font-medium text-gray-900 mt-1">{{ getRequestTypeName() }}</dd>
                </div>
                <div>
                  <dt class="text-gray-600">Property Address</dt>
                  <dd class="font-medium text-gray-900 mt-1">{{ formData.property_address || 'N/A' }}</dd>
                </div>
                <div>
                  <dt class="text-gray-600">Brief Description</dt>
                  <dd class="font-medium text-gray-900 mt-1">{{ formData.brief_description || 'N/A' }}</dd>
                </div>
                <div>
                  <dt class="text-gray-600">Estimated Value</dt>
                  <dd class="font-medium text-gray-900 mt-1">
                    {{ formData.estimated_value ? `$${formData.estimated_value}` : 'N/A' }}
                  </dd>
                </div>
                <div>
                  <dt class="text-gray-600">Documents Uploaded</dt>
                  <dd class="font-medium text-gray-900 mt-1">{{ uploadedFiles.length }} files</dd>
                </div>
              </dl>
            </div>

            <!-- Terms & Conditions -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
              <div class="flex items-start">
                <input
                  type="checkbox"
                  v-model="formData.terms_accepted"
                  class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                />
                <label class="ml-3 text-sm text-gray-700">
                  I confirm that the information provided in this application is true and accurate to the best of my knowledge.
                  I understand that providing false or misleading information may result in the application being declined or
                  consent being revoked. I have read and agree to the
                  <a href="#" class="text-blue-600 hover:text-blue-800">terms and conditions</a>.
                </label>
              </div>
            </div>

            <!-- Fee Summary -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h4 class="font-medium text-blue-900 mb-3">Fee Summary</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-blue-800">Application Fee</span>
                  <span class="font-medium text-blue-900">{{ getApplicationFee() }}</span>
                </div>
                <div class="flex justify-between pt-2 border-t border-blue-200">
                  <span class="font-medium text-blue-900">Total Due</span>
                  <span class="text-lg font-bold text-blue-900">{{ getApplicationFee() }}</span>
                </div>
              </div>
              <p class="text-xs text-blue-700 mt-3">
                Payment will be processed after submission. You will receive an invoice via email.
              </p>
            </div>

            <!-- Pre-Application Meeting (Resource Consent Only) -->
            <div v-if="isResourceConsent" class="bg-green-50 border border-green-200 rounded-lg p-6">
              <h4 class="font-medium text-green-900 mb-2">Pre-Application Meeting</h4>
              <p class="text-sm text-green-700 mb-4">
                For Resource Consent applications, we strongly recommend booking a pre-application meeting with our planning team.
                This helps ensure your application meets all requirements and can speed up the approval process.
              </p>
              <Button
                @click="bookPreApplicationMeeting"
                variant="solid"
                theme="green"
                :loading="bookingMeeting"
              >
                <template #prefix>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </template>
                Book Pre-Application Meeting
              </Button>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
          <Button
            v-if="currentStep > 1"
            @click="previousStep"
            variant="outline"
            theme="gray"
          >
            <template #prefix>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </template>
            Previous
          </Button>
          <div v-else></div>

          <div class="flex space-x-3">
            <Button
              v-if="currentStep < totalSteps"
              @click="nextStep"
              variant="solid"
              theme="blue"
              :disabled="!canProceed()"
            >
              Next
              <template #suffix>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </template>
            </Button>
            <Button
              v-else-if="canSubmit"
              @click="submitApplication"
              variant="solid"
              theme="blue"
              :loading="submitting"
              :disabled="!formData.terms_accepted"
            >
              Submit Application
            </Button>
            <div v-else class="text-sm text-gray-500">
              Make changes to your application to enable submission
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Affected Party Modal -->
    <div
      v-if="showAffectedPartyModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      @click.self="cancelAffectedParty"
    >
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">
              {{ editingPartyIndex !== null ? 'Edit' : 'Add' }} Affected Party
            </h3>
            <button
              @click="cancelAffectedParty"
              class="text-gray-400 hover:text-gray-600"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <div class="px-6 py-4 space-y-4">
          <!-- Party Name * -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Party Name <span class="text-red-500">*</span>
            </label>
            <input
              v-model="affectedPartyForm.party_name"
              type="text"
              required
              placeholder="e.g., John Smith"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <!-- Relationship * -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Relationship <span class="text-red-500">*</span>
            </label>
            <select
              v-model="affectedPartyForm.relationship"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Select relationship</option>
              <option value="Adjacent Property Owner">Adjacent Property Owner</option>
              <option value="Neighbor">Neighbor</option>
              <option value="Iwi">Iwi</option>
              <option value="Infrastructure Provider">Infrastructure Provider</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Contact Information -->
          <div class="border-t border-gray-200 pt-4">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Contact Information</h4>

            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                <input
                  v-model="affectedPartyForm.email"
                  type="email"
                  placeholder="email@example.com"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                />
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Phone</label>
                <input
                  v-model="affectedPartyForm.phone"
                  type="tel"
                  placeholder="021 123 4567"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                />
              </div>
            </div>
          </div>

          <!-- Addresses -->
          <div class="border-t border-gray-200 pt-4">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Addresses</h4>

            <div class="space-y-3">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Property Address</label>
                <textarea
                  v-model="affectedPartyForm.property_address"
                  rows="2"
                  placeholder="123 Main Street, Suburb, City"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                ></textarea>
                <p class="mt-1 text-xs text-gray-500">The property address affected by this proposal</p>
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Postal Address</label>
                <textarea
                  v-model="affectedPartyForm.postal_address"
                  rows="2"
                  placeholder="PO Box 123, Suburb, City"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                ></textarea>
                <p class="mt-1 text-xs text-gray-500">For correspondence (if different from property address)</p>
              </div>
            </div>
          </div>

          <!-- Approval -->
          <div class="border-t border-gray-200 pt-4">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Written Approval</h4>

            <div class="flex items-start mb-3">
              <input
                type="checkbox"
                v-model="affectedPartyForm.approval_obtained"
                class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <label class="ml-3 text-sm text-gray-700">
                Written approval obtained from this party
              </label>
            </div>

            <div v-if="affectedPartyForm.approval_obtained" class="ml-7 space-y-3">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Approval Date</label>
                <input
                  v-model="affectedPartyForm.approval_date"
                  type="date"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                />
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Approval Document</label>
                <input
                  type="file"
                  @change="handleApprovalDocumentUpload"
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
                <p class="mt-1 text-xs text-gray-500">Upload written approval (PDF, Word, or image, max 10MB)</p>
                <div v-if="affectedPartyForm.approval_document" class="mt-2 text-xs text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span>{{ typeof affectedPartyForm.approval_document === 'object' ? affectedPartyForm.approval_document.name : 'Document attached' }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Comments -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Comments</label>
            <textarea
              v-model="affectedPartyForm.comments"
              rows="3"
              placeholder="Any additional notes about this party or their concerns..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
            ></textarea>
          </div>
        </div>

        <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end gap-3">
          <button
            @click="cancelAffectedParty"
            type="button"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            @click="saveAffectedParty"
            type="button"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
          >
            {{ editingPartyIndex !== null ? 'Update' : 'Add' }} Party
          </button>
        </div>
      </div>
    </div>

    <!-- Specialist Report Modal -->
    <div
      v-if="showSpecialistReportModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      @click.self="cancelSpecialistReport"
    >
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">
              {{ editingReportIndex !== null ? 'Edit' : 'Add' }} Specialist Report
            </h3>
            <button
              @click="cancelSpecialistReport"
              class="text-gray-400 hover:text-gray-600"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <div class="px-6 py-4 space-y-4">
          <!-- Report Type * -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Report Type <span class="text-red-500">*</span>
            </label>
            <select
              v-model="specialistReportForm.report_type"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Select report type</option>
              <option value="Traffic Impact Assessment">Traffic Impact Assessment</option>
              <option value="Acoustic Assessment">Acoustic Assessment</option>
              <option value="Geotechnical Report">Geotechnical Report</option>
              <option value="Ecological Assessment">Ecological Assessment</option>
              <option value="Archaeological Assessment">Archaeological Assessment</option>
              <option value="Landscape Assessment">Landscape Assessment</option>
              <option value="Contaminated Land Assessment">Contaminated Land Assessment</option>
              <option value="Flood Risk Assessment">Flood Risk Assessment</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Consultant Details -->
          <div class="border-t border-gray-200 pt-4">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Consultant Details</h4>

            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Specialist Name <span class="text-red-500">*</span>
                </label>
                <input
                  v-model="specialistReportForm.specialist_name"
                  type="text"
                  required
                  placeholder="e.g., Dr. Jane Smith"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Company/Organization</label>
                <input
                  v-model="specialistReportForm.specialist_company"
                  type="text"
                  placeholder="e.g., ABC Consultants Ltd"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
            </div>
          </div>

          <!-- Report Details -->
          <div class="border-t border-gray-200 pt-4">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Report Details</h4>

            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Report Date <span class="text-red-500">*</span>
                </label>
                <input
                  v-model="specialistReportForm.report_date"
                  type="date"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <p class="mt-1 text-xs text-gray-500">Date the report was prepared or finalized</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Document <span class="text-red-500">*</span>
                </label>
                <input
                  type="file"
                  @change="handleReportDocumentUpload"
                  accept=".pdf,.doc,.docx"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
                <p class="mt-1 text-xs text-gray-500">Upload the specialist report (PDF or Word, max 10MB)</p>
                <div v-if="specialistReportForm.document" class="mt-2 text-xs text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span>{{ typeof specialistReportForm.document === 'object' ? specialistReportForm.document.name : 'Document attached' }}</span>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Summary</label>
                <textarea
                  v-model="specialistReportForm.summary"
                  rows="4"
                  placeholder="Brief summary of key findings and recommendations..."
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                ></textarea>
                <p class="mt-1 text-xs text-gray-500">Optional: Provide a brief summary of the report's key findings</p>
              </div>
            </div>
          </div>
        </div>

        <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end gap-3">
          <button
            @click="cancelSpecialistReport"
            type="button"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            @click="saveSpecialistReport"
            type="button"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
          >
            {{ editingReportIndex !== null ? 'Update' : 'Add' }} Report
          </button>
        </div>
      </div>
    </div>

    <!-- Proposed Conditions Modal -->
    <div
      v-if="showConditionsModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      @click.self="showConditionsModal = false"
    >
      <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">
              Browse Condition Templates
            </h3>
            <button
              @click="showConditionsModal = false"
              class="text-gray-400 hover:text-gray-600"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto">
          <div class="grid md:grid-cols-3 gap-6 p-6">
            <!-- Left Column: Template Browser (2/3 width) -->
            <div class="md:col-span-2 space-y-4">
              <!-- Category Filter -->
              <div class="flex items-center gap-2 mb-4 pb-4 border-b border-gray-200">
                <label class="text-sm font-medium text-gray-700">Filter by Category:</label>
                <select
                  v-model="selectedCategory"
                  class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option v-for="category in conditionCategories" :key="category" :value="category">
                    {{ category }}
                  </option>
                </select>
                <span class="ml-auto text-xs text-gray-500">
                  {{ filteredConditionTemplates.length }} template{{ filteredConditionTemplates.length !== 1 ? 's' : '' }}
                </span>
              </div>

              <!-- Loading State -->
              <div v-if="loadingTemplates" class="text-center py-12">
                <svg class="animate-spin h-8 w-8 mx-auto text-blue-600" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-sm text-gray-500">Loading templates...</p>
              </div>

              <!-- Templates List -->
              <div v-else-if="filteredConditionTemplates.length > 0" class="space-y-3">
                <div
                  v-for="template in filteredConditionTemplates"
                  :key="template.name"
                  class="p-4 bg-white border border-gray-300 rounded-lg hover:border-blue-400 hover:shadow-sm transition-all"
                >
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <h4 class="text-sm font-semibold text-gray-900">{{ template.template_name }}</h4>
                        <span v-if="template.condition_code" class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs font-mono rounded">
                          {{ template.condition_code }}
                        </span>
                      </div>
                      <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded">
                          {{ template.condition_category }}
                        </span>
                        <span v-if="template.timing" class="px-2 py-0.5 text-xs bg-purple-100 text-purple-700 rounded">
                          {{ template.timing }}
                        </span>
                        <span v-if="template.monitoring_required" class="px-2 py-0.5 text-xs bg-orange-100 text-orange-700 rounded">
                          Monitoring Required
                        </span>
                      </div>
                      <div class="text-xs text-gray-700 line-clamp-3" v-html="template.condition_text"></div>
                    </div>
                    <button
                      @click="addConditionFromTemplate(template)"
                      type="button"
                      class="ml-3 px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 flex items-center gap-1 flex-shrink-0"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                      </svg>
                      Add
                    </button>
                  </div>
                </div>
              </div>

              <!-- No Templates -->
              <div v-else class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="text-sm text-gray-500">No templates found for selected category</p>
              </div>

              <!-- Add Custom Condition Button -->
              <div class="pt-4 border-t border-gray-200">
                <button
                  @click="addCustomCondition"
                  type="button"
                  class="w-full px-4 py-2.5 bg-gray-100 text-gray-700 text-sm rounded-lg hover:bg-gray-200 flex items-center justify-center gap-2 border-2 border-dashed border-gray-300"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  Add Custom Condition
                </button>
              </div>
            </div>

            <!-- Right Column: Selected Conditions (1/3 width) -->
            <div class="md:col-span-1 bg-gray-50 rounded-lg p-4 border border-gray-200">
              <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center justify-between">
                <span>Selected Conditions</span>
                <span class="px-2 py-0.5 bg-blue-600 text-white text-xs rounded-full">
                  {{ formData.proposed_conditions.length }}
                </span>
              </h4>

              <div v-if="formData.proposed_conditions.length > 0" class="space-y-2 max-h-[600px] overflow-y-auto">
                <div
                  v-for="(condition, index) in formData.proposed_conditions"
                  :key="index"
                  class="p-2 bg-white rounded border border-gray-300 text-xs"
                >
                  <div class="flex items-start justify-between mb-1">
                    <div class="flex items-center gap-1">
                      <span class="px-1.5 py-0.5 bg-gray-100 text-gray-700 font-mono text-xs rounded">
                        {{ condition.condition_number }}
                      </span>
                      <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">
                        {{ condition.condition_category }}
                      </span>
                    </div>
                    <button
                      @click="removeCondition(index)"
                      type="button"
                      class="text-red-600 hover:bg-red-50 rounded p-0.5"
                      title="Remove"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  <div class="text-gray-700 line-clamp-2" v-html="condition.condition_text"></div>
                </div>
              </div>

              <div v-else class="text-center py-8 text-xs text-gray-500">
                <svg class="w-8 h-8 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                No conditions selected
              </div>
            </div>
          </div>

          <!-- Custom Condition Editor (appears when editing) -->
          <div v-if="editingConditionIndex !== null || conditionForm.condition_text || conditionForm.condition_category" class="border-t border-gray-200 bg-gray-50 p-6">
            <h4 class="text-sm font-semibold text-gray-900 mb-4">
              {{ editingConditionIndex !== null ? 'Edit' : 'Add Custom' }} Condition
            </h4>

            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">
                  Condition Number <span class="text-red-500">*</span>
                </label>
                <input
                  v-model="conditionForm.condition_number"
                  type="text"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="e.g., 1"
                />
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">
                  Category <span class="text-red-500">*</span>
                </label>
                <select
                  v-model="conditionForm.condition_category"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Select category</option>
                  <option v-for="category in conditionCategories.filter(c => c !== 'All')" :key="category" :value="category">
                    {{ category }}
                  </option>
                </select>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Condition Text <span class="text-red-500">*</span>
              </label>
              <textarea
                v-model="conditionForm.condition_text"
                rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter the condition text..."
              ></textarea>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Notes</label>
              <textarea
                v-model="conditionForm.compliance_notes"
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Optional notes about this condition..."
              ></textarea>
            </div>

            <div class="flex justify-end gap-2 mt-4">
              <button
                @click="cancelConditionEdit"
                type="button"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                @click="saveCondition"
                type="button"
                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
              >
                {{ editingConditionIndex !== null ? 'Update' : 'Add' }} Condition
              </button>
            </div>
          </div>
        </div>

        <div class="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4 flex justify-end">
          <button
            @click="showConditionsModal = false"
            type="button"
            class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
          >
            Done
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { createResource, Input, Button, call } from 'frappe-ui'
import CouncilSelector from '../components/CouncilSelector.vue'
import { useCouncilStore } from '../stores/councilStore'
import { session } from '../data/session'

const router = useRouter()
const councilStore = useCouncilStore()

// User profile data
const userProfile = ref(null)
const loadingProfile = ref(false)

// Form state
const currentStep = ref(1)
const totalSteps = computed(() => steps.value.length)
const savingDraft = ref(false)
const submitting = ref(false)
const uploadedFiles = ref([])
const fileInput = ref(null)
const bookingMeeting = ref(false)
const requestingMeeting = ref(false)
const showActivityStatusHelp = ref(false)

// Available consent types (managed configuration)
const availableConsentTypes = [
  'Land Use',
  'Subdivision',
  'Discharge Permit',
  'Water Permit',
  'Coastal Permit'
]

// Consent type multi-select functions
const toggleConsentType = (consentType) => {
  const index = formData.value.consent_types.findIndex(ct => ct.consent_type === consentType)
  if (index > -1) {
    formData.value.consent_types.splice(index, 1)
  } else {
    formData.value.consent_types.push({ consent_type: consentType })
  }
}

const isConsentTypeSelected = (consentType) => {
  return formData.value.consent_types.some(ct => ct.consent_type === consentType)
}

const steps = computed(() => {
  const baseSteps = [
    { title: 'Council', number: 1 },
    { title: 'Type', number: 2 },
    { title: 'Property', number: 3 }
  ]

  // Add RC-specific step
  if (isResourceConsent.value) {
    baseSteps.push({ title: 'RC Details', number: 4 })
  } else {
    // For non-RC requests, add Additional Information step
    baseSteps.push({ title: 'Additional Info', number: 4 })
  }

  // Review step is always last
  baseSteps.push({ title: 'Review', number: baseSteps.length + 1 })

  return baseSteps
})

// Form data
const formData = ref({
  council: '',
  request_type: '',
  request_category: '', // Store the category of the selected request type
  property: '',
  property_address: '',
  legal_description: '',
  valuation_reference: '',
  zone: '',
  brief_description: '',
  detailed_description: '',
  estimated_value: null,
  proposed_start_date: '',
  terms_accepted: false,

  // Required applicant fields
  applicant_phone: '',
  applicant_type: '',

  // Agent workflow fields
  acting_on_behalf: false,
  applicant_name: '',
  applicant_email: '',

  // Resource Consent specific fields
  consent_types: [], // Array of consent type objects
  activity_status: '',
  applicant_reference_number: '',
  delivery_preference: '',
  pim_reference: '',

  // Proposal Details
  building_height: null,
  building_floor_area: null,
  earthworks_volume: null,
  earthworks_vertical_alteration: null,
  vehicle_movements_daily: null,
  parking_spaces_provided: null,
  hours_of_operation: '',
  consent_term_requested: '',

  // Site & Environment
  site_topography: '',
  existing_vegetation_description: '',
  watercourses_present: false,
  watercourse_description: '',
  existing_infrastructure: '',
  contamination_status_hail: '',

  // Permitted Boundary Activity (RMA s87BA)
  boundary_description: '',
  boundary_activity_description: '',
  boundary_owner_approval_obtained: false,
  boundary_approval_date: '',
  boundary_approval_document: null,

  // Natural Hazards (structured)
  natural_hazards: [],

  // NES Assessments
  nes_assessments: [],

  // HAIL Activities
  hail_activities: [],

  // Confidential Information (RMA s42)
  confidential_information_claimed: false,
  confidential_information_reason: '',

  // AEE Fields
  assessment_of_effects: '',
  effects_on_people: '',
  physical_effects: '',
  earthworks_effects: '',
  discharge_contaminants_effects: '',
  ecosystem_effects: '',
  hazard_risk_assessment: '',
  cultural_effects: '',

  planning_assessment: '',
  rma_part2_assessment: '', // RMA Part 2 principles assessment
  alternatives_considered: '',
  mitigation_proposed: '',

  // Affected Parties
  affected_parties: [], // Array of affected parties
  written_approvals_obtained: 0, // Count of approvals obtained

  // Iwi Consultation
  iwi_consultation_undertaken: false,
  iwi_consulted: '',
  cultural_impact_assessment: null, // CIA file upload
  iwi_response_summary: '', // Summary of iwi consultation responses

  // Specialist Reports & Conditions
  specialist_reports: [], // Array of specialist reports
  proposed_conditions: [], // Array of proposed conditions
})

// Natural Hazards - RMA s104
const naturalHazardTypes = [
  'Earthquake',
  'Fire',
  'Tsunami',
  'Erosion',
  'Volcanic and Geothermal',
  'Flood',
  'Sedimentation',
  'Subsidence',
  'Wind',
  'Landslip',
  'Drought'
]

const selectedHazards = ref([])
const hazardData = ref({})

// Get or create hazard data object
const getHazardData = (hazard) => {
  if (!hazardData.value[hazard]) {
    hazardData.value[hazard] = {
      hazard_type: hazard,
      present: true,
      risk_level: '',
      assessment_notes: '',
      mitigation_required: false
    }
  }
  return hazardData.value[hazard]
}

// Watch selectedHazards to update formData.natural_hazards
watch(selectedHazards, (newHazards) => {
  formData.value.natural_hazards = newHazards.map(hazard => getHazardData(hazard))
}, { deep: true })

// Watch hazardData to update formData.natural_hazards
watch(hazardData, () => {
  formData.value.natural_hazards = selectedHazards.value.map(hazard => getHazardData(hazard))
}, { deep: true })

// National Environmental Standards
const nesTypes = [
  { value: 'NES for Assessing and Managing Contaminants in Soil (HAIL)', label: 'NES for Assessing and Managing Contaminants in Soil (HAIL)' },
  { value: 'NES for Air Quality', label: 'NES for Air Quality' },
  { value: 'NES for Sources of Human Drinking Water', label: 'NES for Sources of Human Drinking Water' },
  { value: 'NES for Freshwater Management', label: 'NES for Freshwater Management' },
  { value: 'NES for Plantation Forestry', label: 'NES for Plantation Forestry' },
  { value: 'NES for Electricity Transmission Activities', label: 'NES for Electricity Transmission Activities' },
  { value: 'NES for Telecommunication Facilities', label: 'NES for Telecommunication Facilities' },
  { value: 'Other', label: 'Other NES' }
]

const nesData = ref({})

// Get or create NES data object
const getNESData = (nesType) => {
  if (!nesData.value[nesType]) {
    nesData.value[nesType] = {
      nes_type: nesType,
      applies: false,
      compliance_status: '',
      assessment_notes: '',
      other_nes_description: ''
    }
  }
  return nesData.value[nesType]
}

// NES Document Upload Handling
const handleNESDocumentUpload = (event, nesType) => {
  const file = event.target.files[0]
  if (!file) return

  // Validation
  if (file.size > 10 * 1024 * 1024) {
    alert('File size must be less than 10MB')
    event.target.value = ''
    return
  }

  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/jpg', 'image/png']
  if (!allowedTypes.includes(file.type)) {
    alert('Only PDF, Word documents, and images are allowed')
    event.target.value = ''
    return
  }

  // Add to attachments with NES category
  formData.value.attachments.push({
    document_category: 'NES Documentation',
    document_type: 'NES Assessment',
    file: file,
    description: `NES Assessment for ${nesType}`,
    nes_type: nesType  // Track which NES this belongs to
  })

  event.target.value = ''
}

const getNESDocuments = (nesType) => {
  return formData.value.attachments.filter(att =>
    att.document_category === 'NES Documentation' && att.nes_type === nesType
  )
}

const removeNESDocument = (nesType, docIdx) => {
  const nesDocuments = getNESDocuments(nesType)
  const docToRemove = nesDocuments[docIdx]
  const globalIdx = formData.value.attachments.indexOf(docToRemove)
  if (globalIdx > -1) {
    formData.value.attachments.splice(globalIdx, 1)
  }
}

// Watch nesData to update formData.nes_assessments
watch(nesData, () => {
  formData.value.nes_assessments = nesTypes
    .filter(nes => getNESData(nes.value).applies)
    .map(nes => getNESData(nes.value))
}, { deep: true })

// Computed: Check if NES Soils is selected (for conditional HAIL section)
const isNESSoilsSelected = computed(() => {
  return formData.value.nes_assessments.some(
    nes => nes.nes_type && nes.nes_type.includes('HAIL')
  )
})

// HAIL Activities Management
const addHAILActivity = () => {
  formData.value.hail_activities.push({
    activity_description: '',
    hail_category: '',
    currently_undertaken: false,
    previously_undertaken: false,
    likely_undertaken: false,
    preliminary_investigation_done: false,
    proposed_activities: [],  // Changed to array for multiple selections
    notes: ''
  })
}

const removeHAILActivity = (index) => {
  formData.value.hail_activities.splice(index, 1)
}

// HAIL Proposed Activity checkbox handlers
const toggleHAILProposedActivity = (hailIndex, activityType) => {
  const hail = formData.value.hail_activities[hailIndex]
  if (!hail.proposed_activities) {
    hail.proposed_activities = []
  }

  const activityIndex = hail.proposed_activities.findIndex(a => a.activity_type === activityType)
  if (activityIndex > -1) {
    hail.proposed_activities.splice(activityIndex, 1)
  } else {
    hail.proposed_activities.push({ activity_type: activityType })
  }
}

const isHAILActivitySelected = (hailIndex, activityType) => {
  const hail = formData.value.hail_activities[hailIndex]
  if (!hail.proposed_activities) return false
  return hail.proposed_activities.some(a => a.activity_type === activityType)
}

// Boundary Approval Document Upload
const handleBoundaryApprovalUpload = (event) => {
  const file = event.target.files[0]
  if (file) {
    formData.value.boundary_approval_document = file
  }
}

// Track initial form state to detect changes
const initialFormData = ref(JSON.parse(JSON.stringify(formData.value)))

// Computed property to check if form has changes
// Exclude terms_accepted from change detection since it's not actual application data
const hasFormChanges = computed(() => {
  const currentCopy = { ...formData.value }
  const initialCopy = { ...initialFormData.value }

  // Remove terms_accepted from comparison
  delete currentCopy.terms_accepted
  delete initialCopy.terms_accepted

  const current = JSON.stringify(currentCopy)
  const initial = JSON.stringify(initialCopy)
  return current !== initial
})

// Computed property to check if Resource Consent request
const isResourceConsent = computed(() => {
  return formData.value.request_category === 'Resource Consent'
})

// Activity status validation warning
const activityStatusWarning = computed(() => {
  if (!formData.value.activity_status) return null

  switch (formData.value.activity_status) {
    case 'Non-Complying':
      return '⚠️ Non-complying activities face higher scrutiny and longer processing times. Consider pre-application meeting.'
    case 'Discretionary':
      return 'ℹ️ Discretionary activities may require public notification depending on effects assessment.'
    case 'Controlled':
      return '✓ Controlled activities must be granted consent. Council will focus on appropriate conditions.'
    default:
      return null
  }
})

// Show submit button only if there are changes or files uploaded
const canSubmit = computed(() => {
  return hasFormChanges.value || uploadedFiles.value.length > 0
})

// Get request types (will be loaded based on council selection)
const requestTypes = ref({ data: [], loading: false, error: null })

// Get user's properties
const properties = createResource({
  url: 'frappe.client.get_list',
  params: {
    doctype: 'Property',
    fields: ['name', 'property_id', 'street_address', 'suburb', 'city'],
    limit_page_length: 100,
  },
  auto: true,
})

// Methods
const onCouncilChange = async (councilCode) => {
  if (!councilCode) {
    requestTypes.value = { data: [], loading: false, error: null }
    return
  }

  // Load request types for the selected council
  requestTypes.value.loading = true
  requestTypes.value.error = null

  try {
    await councilStore.loadRequestTypesForCouncil(councilCode)
    requestTypes.value.data = councilStore.availableRequestTypes
    console.log(`[NewRequest] Loaded ${requestTypes.value.data.length} request types for council ${councilCode}`)
  } catch (error) {
    requestTypes.value.error = error.message || 'Failed to load request types'
    console.error('[NewRequest] Failed to load request types:', error)
  } finally {
    requestTypes.value.loading = false
  }
}

const goBack = () => {
  if (confirm('Are you sure you want to leave? Any unsaved changes will be lost.')) {
    router.push({ name: 'Dashboard' })
  }
}

const getStepClass = (stepNumber) => {
  if (stepNumber < currentStep.value) {
    return 'bg-blue-600 text-white'
  } else if (stepNumber === currentStep.value) {
    return 'bg-blue-600 text-white'
  } else {
    return 'bg-gray-200 text-gray-600'
  }
}

const selectRequestType = (type) => {
  console.log('[NewRequest] Selecting Request Type:', type.name, type.type_name)
  formData.value.request_type = type.name
  formData.value.request_category = type.category || ''
  console.log('[NewRequest] Form data updated:', { request_type: formData.value.request_type, request_category: formData.value.request_category })
}

const onPropertySelect = () => {
  if (formData.value.property) {
    const selected = properties.data.find(p => p.name === formData.value.property)
    if (selected) {
      formData.value.property_address = `${selected.street_address}, ${selected.suburb}, ${selected.city}`
    }
  }
}

const canProceed = () => {
  switch (currentStep.value) {
    case 1:
      // Step 1: Council selection
      const canProceedStep1 = !!formData.value.council
      console.log('[NewRequest] canProceed Step 1 (Council):', canProceedStep1, 'council:', formData.value.council)
      return canProceedStep1
    case 2:
      // Step 2: Request type selection
      const canProceedStep2 = !!formData.value.request_type
      console.log('[NewRequest] canProceed Step 2 (Type):', canProceedStep2, 'request_type:', formData.value.request_type)
      return canProceedStep2
    case 3:
      // Step 3: Property - Require either property link OR property_address, plus applicant fields
      const hasProperty = formData.value.property || formData.value.property_address
      const hasApplicantInfo = formData.value.applicant_phone && formData.value.applicant_type && formData.value.applicant_name && formData.value.applicant_email
      return !!(hasProperty && hasApplicantInfo)
    case 4:
      // Step 4: RC Details (Resource Consent) OR Additional Info (non-RC)
      if (isResourceConsent.value) {
        // RC Details step - validate required fields
        return !!(
          formData.value.consent_types && formData.value.consent_types.length > 0 &&
          formData.value.activity_status &&
          formData.value.assessment_of_effects &&
          formData.value.planning_assessment
        )
      } else {
        // Additional Info step - just need brief description
        return !!formData.value.brief_description
      }
    case 5:
      // Step 5: Review step - always allow to proceed
      return true
    default:
      return true
  }
}

const nextStep = () => {
  const totalStepsValue = totalSteps.value
  const currentStepValue = currentStep.value
  const canProceedValue = canProceed()

  console.log('[NewRequest] nextStep called', {
    canProceed: canProceedValue,
    currentStep: currentStepValue,
    totalSteps: totalStepsValue,
    steps: steps.value,
    willProceed: canProceedValue && currentStepValue < totalStepsValue
  })

  if (canProceedValue && currentStepValue < totalStepsValue) {
    currentStep.value++
    console.log('[NewRequest] Moved to step:', currentStep.value)
  } else {
    console.warn('[NewRequest] Cannot proceed:', {
      canProceed: canProceedValue,
      currentStep: currentStepValue,
      totalSteps: totalStepsValue,
      reason: !canProceedValue ? 'canProceed returned false' : 'at last step'
    })
  }
}

const previousStep = () => {
  if (currentStep.value > 1) {
    currentStep.value--
  }
}

const saveDraft = async () => {
  savingDraft.value = true
  try {
    const response = await fetch('/api/method/lodgeick.api.create_draft_request', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Frappe-CSRF-Token': window.csrf_token
      },
      body: JSON.stringify({
        data: formData.value
      })
    })

    const result = await response.json()

    if (result.message && result.message.success) {
      alert(`Draft saved successfully! Request ID: ${result.message.request_number}`)
      // Return the result for use by other functions
      return result.message
    } else {
      throw new Error(result.message || 'Failed to save draft')
    }
  } catch (error) {
    console.error('Error saving draft:', error)
    alert('Failed to save draft. Please try again.')
    return null
  } finally {
    savingDraft.value = false
  }
}

const triggerFileUpload = () => {
  fileInput.value.click()
}

const handleFileUpload = (event) => {
  const files = Array.from(event.target.files)
  uploadedFiles.value.push(...files)
}

const removeFile = (index) => {
  uploadedFiles.value.splice(index, 1)
}

const formatFileSize = (bytes) => {
  if (bytes === 0) return '0 Bytes'
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
}

const getRequestTypeName = () => {
  const type = requestTypes.data?.find(t => t.name === formData.value.request_type)
  return type?.type_name || 'N/A'
}

const getApplicationFee = () => {
  const type = requestTypes.data?.find(t => t.name === formData.value.request_type)
  return type?.base_fee ? `$${type.base_fee}` : 'TBD'
}

const submitApplication = async () => {
  if (!formData.value.terms_accepted) {
    alert('Please accept the terms and conditions')
    return
  }

  submitting.value = true
  try {
    // Step 1: Create draft request
    const createResponse = await fetch('/api/method/lodgeick.api.create_draft_request', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Frappe-CSRF-Token': window.csrf_token
      },
      body: JSON.stringify({
        data: formData.value
      })
    })

    const createResult = await createResponse.json()

    if (!createResult.message || !createResult.message.success) {
      throw new Error('Failed to create request')
    }

    const requestId = createResult.message.request_id

    // Step 2: Upload files if any
    if (uploadedFiles.value.length > 0) {
      for (const file of uploadedFiles.value) {
        const fileFormData = new FormData()
        fileFormData.append('file', file)
        fileFormData.append('doctype', 'Request')
        fileFormData.append('docname', requestId)
        fileFormData.append('is_private', 0)

        await fetch('/api/method/upload_file', {
          method: 'POST',
          headers: {
            'X-Frappe-CSRF-Token': window.csrf_token
          },
          body: fileFormData
        })
      }
    }

    // Step 3: Submit the request
    const submitResponse = await fetch('/api/method/lodgeick.lodgeick.doctype.request.request.submit_application', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Frappe-CSRF-Token': window.csrf_token
      },
      body: JSON.stringify({
        request_id: requestId
      })
    })

    const submitResult = await submitResponse.json()

    if (submitResult.message && submitResult.message.success) {
      alert(`Application submitted successfully! Request Number: ${submitResult.message.request_number}`)
      router.push({ name: 'Dashboard' })
    } else {
      throw new Error('Failed to submit application')
    }
  } catch (error) {
    console.error('Error submitting application:', error)
    alert('Failed to submit application')
  } finally {
    submitting.value = false
  }
}

const bookPreApplicationMeeting = async () => {
  if (!formData.value.request_type) {
    alert('Please complete your application details first')
    return
  }

  bookingMeeting.value = true
  try {
    // First, save as draft if not already saved
    const draftResponse = await fetch('/api/method/lodgeick.api.create_draft_request', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Frappe-CSRF-Token': window.csrf_token
      },
      body: JSON.stringify({
        data: formData.value
      })
    })

    const draftResult = await draftResponse.json()

    if (!draftResult.message || !draftResult.message.success) {
      throw new Error('Failed to save application')
    }

    const requestId = draftResult.message.request_id

    // Book the meeting via backend API
    const meetingResponse = await fetch('/api/method/lodgeick.api.book_council_meeting', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Frappe-CSRF-Token': window.csrf_token
      },
      body: JSON.stringify({
        request_id: requestId,
        meeting_type: 'Pre-Application Meeting'
      })
    })

    const meetingResult = await meetingResponse.json()

    if (meetingResult.message && meetingResult.message.success) {
      alert(`Pre-Application Meeting request has been submitted! A council officer will contact you within 2 business days to schedule the meeting. Task ID: ${meetingResult.message.task_id}`)
    } else {
      throw new Error(meetingResult.message || 'Failed to book meeting')
    }
  } catch (error) {
    console.error('Error booking meeting:', error)
    alert('Failed to book pre-application meeting. Please try again.')
  } finally {
    bookingMeeting.value = false
  }
}

// Resource Consent specific methods
const ciaFileInput = ref(null)

// Affected Party Modal
const showAffectedPartyModal = ref(false)
const editingPartyIndex = ref(null)
const affectedPartyForm = ref({
  party_name: '',
  relationship: '',
  property_address: '',
  email: '',
  phone: '',
  postal_address: '',
  approval_obtained: false,
  approval_date: '',
  approval_document: null,
  comments: ''
})

const addAffectedParty = () => {
  // Reset form
  affectedPartyForm.value = {
    party_name: '',
    relationship: '',
    property_address: '',
    email: '',
    phone: '',
    postal_address: '',
    approval_obtained: false,
    approval_date: '',
    approval_document: null,
    comments: ''
  }
  editingPartyIndex.value = null
  showAffectedPartyModal.value = true
}

const editAffectedParty = (index) => {
  affectedPartyForm.value = { ...formData.value.affected_parties[index] }
  editingPartyIndex.value = index
  showAffectedPartyModal.value = true
}

const saveAffectedParty = () => {
  if (!affectedPartyForm.value.party_name || !affectedPartyForm.value.relationship) {
    alert('Please enter party name and relationship')
    return
  }

  if (editingPartyIndex.value !== null) {
    // Edit existing
    formData.value.affected_parties[editingPartyIndex.value] = { ...affectedPartyForm.value }
  } else {
    // Add new
    formData.value.affected_parties.push({ ...affectedPartyForm.value })
  }

  showAffectedPartyModal.value = false
}

const cancelAffectedParty = () => {
  showAffectedPartyModal.value = false
}

const removeAffectedParty = (index) => {
  if (confirm('Remove this affected party?')) {
    formData.value.affected_parties.splice(index, 1)
  }
}

const handleApprovalDocumentUpload = (event) => {
  const file = event.target.files[0]
  if (file) {
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('File size must be less than 10MB')
      event.target.value = ''
      return
    }

    // Validate file type
    const allowedTypes = [
      'application/pdf',
      'application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'image/jpeg',
      'image/jpg',
      'image/png'
    ]
    if (!allowedTypes.includes(file.type)) {
      alert('Only PDF, Word documents, and images (JPG, PNG) are allowed')
      event.target.value = ''
      return
    }

    affectedPartyForm.value.approval_document = file
  }
}

// Specialist Report Modal
const showSpecialistReportModal = ref(false)
const editingReportIndex = ref(null)
const specialistReportForm = ref({
  report_type: '',
  specialist_name: '',
  specialist_company: '',
  report_date: '',
  document: null,
  summary: ''
})

const addSpecialistReport = () => {
  specialistReportForm.value = {
    report_type: '',
    specialist_name: '',
    specialist_company: '',
    report_date: '',
    document: null,
    summary: ''
  }
  editingReportIndex.value = null
  showSpecialistReportModal.value = true
}

const editSpecialistReport = (index) => {
  specialistReportForm.value = { ...formData.value.specialist_reports[index] }
  editingReportIndex.value = index
  showSpecialistReportModal.value = true
}

const saveSpecialistReport = () => {
  if (!specialistReportForm.value.report_type || !specialistReportForm.value.specialist_name || !specialistReportForm.value.report_date) {
    alert('Please enter report type, specialist name, and report date')
    return
  }

  if (editingReportIndex.value !== null) {
    formData.value.specialist_reports[editingReportIndex.value] = { ...specialistReportForm.value }
  } else {
    formData.value.specialist_reports.push({ ...specialistReportForm.value })
  }
  showSpecialistReportModal.value = false
}

const cancelSpecialistReport = () => {
  showSpecialistReportModal.value = false
}

const removeSpecialistReport = (index) => {
  if (confirm('Remove this specialist report?')) {
    formData.value.specialist_reports.splice(index, 1)
  }
}

const handleReportDocumentUpload = (event) => {
  const file = event.target.files[0]
  if (file) {
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('File size must be less than 10MB')
      event.target.value = ''
      return
    }

    // Validate file type
    const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
    if (!allowedTypes.includes(file.type)) {
      alert('Only PDF and Word documents are allowed')
      event.target.value = ''
      return
    }

    specialistReportForm.value.document = file
  }
}

const handleCIAUpload = (event) => {
  const file = event.target.files[0]
  if (file) {
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('File size must be less than 10MB')
      event.target.value = ''
      return
    }

    // Validate file type
    const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
    if (!allowedTypes.includes(file.type)) {
      alert('Only PDF and Word documents are allowed')
      event.target.value = ''
      return
    }

    formData.value.cultural_impact_assessment = file
  }
}

// Proposed Conditions Modal
const showConditionsModal = ref(false)
const editingConditionIndex = ref(null)
const availableConditionTemplates = ref([])
const loadingTemplates = ref(false)
const selectedCategory = ref('All')

const conditionForm = ref({
  condition_number: '',
  condition_category: '',
  condition_text: '',
  compliance_status: 'Not Started',
  compliance_due_date: '',
  compliance_notes: ''
})

const conditionCategories = [
  'All',
  'General',
  'Timing',
  'Lapse',
  'Review',
  'Financial Contribution',
  'Bonds',
  'Monitoring',
  'Environmental Management',
  'Construction',
  'Operation',
  'Landscape',
  'Ecology',
  'Archaeology',
  'Cultural',
  'Traffic',
  'Parking',
  'Noise',
  'Discharge',
  'Earthworks',
  'Heritage',
  'Water',
  'Coastal',
  'Other'
]

// Fetch condition templates based on selected consent types
const fetchConditionTemplates = async () => {
  loadingTemplates.value = true
  try {
    const selectedTypes = formData.value.consent_types.map(ct => ct.consent_type)

    // Fetch templates from backend
    const response = await fetch('/api/method/frappe.client.get_list', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Frappe-CSRF-Token': window.csrf_token
      },
      body: JSON.stringify({
        doctype: 'Consent Condition Template',
        fields: ['name', 'template_name', 'condition_code', 'condition_category', 'condition_text', 'applies_to_consent_types', 'timing', 'monitoring_required'],
        filters: {
          is_active: 1
        },
        limit_page_length: 0
      })
    })

    const data = await response.json()

    if (data.message) {
      // Filter templates that apply to selected consent types
      availableConditionTemplates.value = data.message.filter(template => {
        if (!template.applies_to_consent_types || template.applies_to_consent_types === 'All') {
          return true
        }
        return selectedTypes.some(type => template.applies_to_consent_types.includes(type))
      })
    }
  } catch (error) {
    console.error('Error fetching condition templates:', error)
    alert('Failed to load condition templates')
  } finally {
    loadingTemplates.value = false
  }
}

const filteredConditionTemplates = computed(() => {
  if (selectedCategory.value === 'All') {
    return availableConditionTemplates.value
  }
  return availableConditionTemplates.value.filter(t => t.condition_category === selectedCategory.value)
})

const openConditionsModal = async () => {
  if (!formData.value.consent_types || formData.value.consent_types.length === 0) {
    alert('Please select at least one consent type first')
    return
  }

  await fetchConditionTemplates()
  conditionForm.value = {
    condition_number: '',
    condition_category: '',
    condition_text: '',
    compliance_status: 'Not Started',
    compliance_due_date: '',
    compliance_notes: ''
  }
  editingConditionIndex.value = null
  showConditionsModal.value = true
}

const addConditionFromTemplate = (template) => {
  // Generate a condition number
  const conditionNum = (formData.value.proposed_conditions.length + 1).toString()

  const newCondition = {
    condition_number: conditionNum,
    condition_category: template.condition_category,
    condition_text: template.condition_text,
    compliance_status: 'Not Started',
    compliance_due_date: '',
    compliance_notes: ''
  }

  formData.value.proposed_conditions.push(newCondition)
}

const addCustomCondition = () => {
  conditionForm.value = {
    condition_number: (formData.value.proposed_conditions.length + 1).toString(),
    condition_category: '',
    condition_text: '',
    compliance_status: 'Not Started',
    compliance_due_date: '',
    compliance_notes: ''
  }
  editingConditionIndex.value = null
}

const editCondition = (index) => {
  conditionForm.value = { ...formData.value.proposed_conditions[index] }
  editingConditionIndex.value = index
}

const saveCondition = () => {
  if (!conditionForm.value.condition_category || !conditionForm.value.condition_text) {
    alert('Please enter condition category and text')
    return
  }

  if (editingConditionIndex.value !== null) {
    formData.value.proposed_conditions[editingConditionIndex.value] = { ...conditionForm.value }
  } else {
    formData.value.proposed_conditions.push({ ...conditionForm.value })
  }

  conditionForm.value = {
    condition_number: '',
    condition_category: '',
    condition_text: '',
    compliance_status: 'Not Started',
    compliance_due_date: '',
    compliance_notes: ''
  }
  editingConditionIndex.value = null
}

const cancelConditionEdit = () => {
  conditionForm.value = {
    condition_number: '',
    condition_category: '',
    condition_text: '',
    compliance_status: 'Not Started',
    compliance_due_date: '',
    compliance_notes: ''
  }
  editingConditionIndex.value = null
}

const removeCondition = (index) => {
  if (confirm('Remove this condition?')) {
    formData.value.proposed_conditions.splice(index, 1)
    // Renumber remaining conditions
    formData.value.proposed_conditions.forEach((cond, idx) => {
      cond.condition_number = (idx + 1).toString()
    })
  }
}

// Pre-Application Meeting Request
const meetingResource = createResource({
  url: 'lodgeick.api.book_council_meeting',
  makeParams: (values) => values,
  onSuccess: (data) => {
    if (data && data.success) {
      alert(`✅ Pre-Application Meeting Request Sent!\n\nTask #${data.task_id} has been created for the planning team.\n\nThey will contact you within 2 business days to schedule.`)
    } else {
      alert('Meeting request sent successfully! The planning team will contact you soon.')
    }
    requestingMeeting.value = false
  },
  onError: (error) => {
    console.error('Error requesting meeting:', error)
    alert('Failed to request pre-application meeting. Please try again or contact the planning team directly.')
    requestingMeeting.value = false
  }
})

const requestPreAppMeeting = async () => {
  if (!formData.value.request_type || !formData.value.property_address) {
    alert('Please complete the Request Type and Property Details first.')
    return
  }

  if (!confirm('Request a pre-application meeting? A planning officer will contact you within 2 business days to schedule.\n\nNote: You should save your application as a draft first.')) {
    return
  }

  try {
    requestingMeeting.value = true

    // First, save the draft
    const draftResult = await saveDraft()

    if (!draftResult || !draftResult.request_id) {
      alert('Please save your draft application first.')
      requestingMeeting.value = false
      return
    }

    // Then request the meeting
    meetingResource.submit({
      request_id: draftResult.request_id,
      meeting_type: 'Pre-Application Meeting'
    })
  } catch (error) {
    console.error('Error in meeting request:', error)
    alert('Failed to request pre-application meeting. Please try again.')
    requestingMeeting.value = false
  }
}

// Initialize on mount
// Load user profile and auto-populate fields
const loadUserProfile = async () => {
  try {
    loadingProfile.value = true
    const profile = await call('lodgeick.api.get_user_profile')
    userProfile.value = profile

    // Auto-populate applicant type from profile default
    if (profile.applicant_type && !formData.value.applicant_type) {
      formData.value.applicant_type = profile.applicant_type
    }

    // Auto-populate phone if not acting on behalf
    if (profile.phone && !formData.value.applicant_phone && !formData.value.acting_on_behalf) {
      formData.value.applicant_phone = profile.phone
    }

    // Auto-populate applicant name and email when not acting on behalf
    if (!formData.value.acting_on_behalf) {
      formData.value.applicant_name = `${profile.first_name || ''} ${profile.last_name || ''}`.trim() || profile.email
      formData.value.applicant_email = profile.email
    }
  } catch (error) {
    console.error('Error loading user profile:', error)
  } finally {
    loadingProfile.value = false
  }
}

// Watch acting_on_behalf to auto-populate or clear applicant details
watch(() => formData.value.acting_on_behalf, (actingOnBehalf) => {
  if (!actingOnBehalf && userProfile.value) {
    // Auto-populate from profile
    formData.value.applicant_name = `${userProfile.value.first_name || ''} ${userProfile.value.last_name || ''}`.trim() || userProfile.value.email
    formData.value.applicant_email = userProfile.value.email
    if (userProfile.value.phone) {
      formData.value.applicant_phone = userProfile.value.phone
    }
    if (userProfile.value.applicant_type) {
      formData.value.applicant_type = userProfile.value.applicant_type
    }
  } else if (actingOnBehalf) {
    // Clear fields for agent to fill in client details
    formData.value.applicant_name = ''
    formData.value.applicant_email = ''
    formData.value.applicant_phone = ''
    // Keep applicant_type as it might be different for the client
  }
})

// Watch phone number to save back to profile when user updates it (and not acting on behalf)
watch(() => formData.value.applicant_phone, async (newPhone, oldPhone) => {
  // Only save if:
  // 1. Not acting on behalf (it's their own application)
  // 2. Profile is loaded
  // 3. Phone has actually changed
  // 4. New phone is not empty
  if (!formData.value.acting_on_behalf && userProfile.value && newPhone && newPhone !== oldPhone && newPhone !== userProfile.value.phone) {
    try {
      await call('lodgeick.api.update_user_profile', {
        phone: newPhone
      })
      // Update local profile copy
      userProfile.value.phone = newPhone
      console.log('[NewRequest] Phone number saved to profile:', newPhone)
    } catch (error) {
      console.error('[NewRequest] Error saving phone to profile:', error)
      // Don't show error to user - this is a background operation
    }
  }
})

onMounted(async () => {
  // Load user profile first
  await loadUserProfile()

  // Check if council was preselected via URL or user default
  if (councilStore.preselectedFromUrl) {
    formData.value.council = councilStore.preselectedFromUrl
    await onCouncilChange(councilStore.preselectedFromUrl)
  } else {
    // Try to load user's default council
    const userCouncils = await councilStore.getUserCouncils()
    if (userCouncils.default_council) {
      formData.value.council = userCouncils.default_council
      await onCouncilChange(userCouncils.default_council)
    }
  }
})
</script>
