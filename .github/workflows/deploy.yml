name: Deploy Lodgeick to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SERVER_HOST: 77.37.87.141
  SERVER_USER: frappe-user
  BENCH_PATH: /home/frappe-user/frappe-bench
  SITE_NAME: lodgeick.com
  APP_NAME: lodgeick

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Production Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            set -e
            echo 'ðŸš€ Starting Lodgeick deployment...'

            # Mark repo as safe
            git config --global --add safe.directory ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }}

            # Pull latest code using the private SSH key
            echo 'ðŸ“¥ Pulling latest code...'
            export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_ed25519_benja_repo -o StrictHostKeyChecking=no'
            cd ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }}
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # Install frontend dependencies
            echo 'ðŸ“¦ Installing frontend dependencies...'
            cd frontend
            yarn install --frozen-lockfile || yarn install

            # Build frontend
            echo 'ðŸ”¨ Building frontend...'
            yarn build

            # Clear Python bytecode cache
            echo 'ðŸ§¹ Clearing Python bytecode cache...'
            find ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }} -type f -name '*.pyc' -delete
            find ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }} -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true

            # Build backend assets
            echo 'ðŸ”¨ Building backend assets...'
            cd ${{ env.BENCH_PATH }}
            bench build --app ${{ env.APP_NAME }}

            # Database migrations
            echo 'ðŸ—„ï¸ Migrating database...'
            bench --site ${{ env.SITE_NAME }} migrate

            # Clear cache
            echo 'ðŸ§¹ Clearing cache...'
            bench --site ${{ env.SITE_NAME }} clear-cache
            bench --site ${{ env.SITE_NAME }} clear-website-cache

            # Restart bench services (gracefully handle supervisor errors)
            echo 'ðŸ”„ Restarting bench services...'
            bench restart || true

            # Stop all supervisor processes
            echo 'ðŸ›‘ Stopping supervisor processes...'
            sudo supervisorctl stop all || true
            sleep 2

            # Reload supervisor configuration
            echo 'ðŸ” Reloading supervisor configuration...'
            sudo supervisorctl reread
            sudo supervisorctl update

            # Start all supervisor processes
            echo 'â–¶ï¸ Starting supervisor processes...'
            sudo supervisorctl start all || true
            sleep 2

            # Reload nginx
            echo 'ðŸ” Reloading nginx...'
            sudo systemctl reload nginx

            echo 'âœ… Lodgeick deployment completed successfully!'
            echo 'ðŸŒ Site: https://${{ env.SITE_NAME }}'
          "

      - name: Verify Deployment
        run: |
          echo 'ðŸ” Verifying deployment...'
          sleep 10
          curl -f -s -o /dev/null https://${{ env.SITE_NAME }} || {
            echo 'âŒ Site not accessible'
            exit 1
          }
          echo 'âœ… Site is accessible at https://${{ env.SITE_NAME }}'

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ env.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Site:** https://${{ env.SITE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
