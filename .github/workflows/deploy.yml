name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SERVER_HOST: 77.37.87.141
  SERVER_USER: frappe-user
  BENCH_PATH: /home/frappe-user/frappe-bench
  SITE_NAME: lodgeick.com
  APP_NAME: lodgeick

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LODGEICK_DEPLOY_KEY }}

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Production Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            set -e
            echo 'ðŸš€ Starting Lodgeick deployment...'

            # Mark repo as safe for git
            git config --global --add safe.directory ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }}

            # Pull latest code using the deploy key configured on the server
            echo 'ðŸ“¥ Pulling latest code...'
            cd ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }}
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # Install frontend dependencies
            echo 'ðŸ“¦ Installing frontend dependencies...'
            cd frontend
            yarn install --frozen-lockfile || yarn install

            # Build frontend
            echo 'ðŸ”¨ Building frontend...'
            yarn build

            # Build backend assets
            echo 'ðŸ”¨ Building backend assets...'
            cd ${{ env.BENCH_PATH }}
            bench build --app ${{ env.APP_NAME }}

            # Run database migrations
            echo 'ðŸ—„ï¸ Migrating database...'
            bench --site ${{ env.SITE_NAME }} migrate

            # Clear cache
            echo 'ðŸ§¹ Clearing cache...'
            bench --site ${{ env.SITE_NAME }} clear-cache
            bench --site ${{ env.SITE_NAME }} clear-website-cache

            # Restart bench services
            echo 'ðŸ”„ Restarting bench services...'
            bench restart

            # Reload nginx and supervisor
            echo 'ðŸ” Reloading nginx and supervisor...'
            sudo systemctl reload nginx
            sudo supervisorctl reread
            sudo supervisorctl update
            sudo supervisorctl restart all

            echo 'âœ… Lodgeick deployment completed successfully!'
            echo 'ðŸŒ Site: https://${{ env.SITE_NAME }}'
          "

      - name: Verify Deployment
        run: |
          echo 'ðŸ” Verifying deployment...'
          sleep 10
          curl -f -s -o /dev/null https://${{ env.SITE_NAME }} || {
            echo 'âŒ Site not accessible'
            exit 1
          }
          echo 'âœ… Site is accessible at https://${{ env.SITE_NAME }}'

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ env.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Site:** https://${{ env.SITE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
