- name: Deploy to Production Server
  run: |
    ssh -o StrictHostKeyChecking=no root@${{ env.SERVER_HOST }} "
      set -e
      echo 'ğŸš€ Starting Lodgeick deployment...'

      git config --global --add safe.directory /home/frappe-user/frappe-bench/apps/lodgeick

      sudo -u frappe-user GIT_SSH_COMMAND=\"ssh -i ~/.ssh/id_ed25519_benja_repo -F /dev/null\" bash -c '
        cd /home/frappe-user/frappe-bench/apps/lodgeick &&
        echo \"ğŸ“¥ Pulling latest code...\" &&
        git fetch origin main &&
        git reset --hard origin/main &&
        git clean -fd

        echo \"ğŸ“¦ Installing frontend dependencies...\"
        cd frontend &&
        yarn install --frozen-lockfile || yarn install

        echo \"ğŸ”¨ Building frontend...\"
        yarn build

        echo \"ğŸ”¨ Building backend assets...\"
        cd /home/frappe-user/frappe-bench &&
        bench build --app lodgeick

        echo \"ğŸ—„ï¸ Migrating database...\"
        bench --site lodgeick.com migrate

        echo \"ğŸ§¹ Clearing cache...\"
        bench --site lodgeick.com clear-cache &&
        bench --site lodgeick.com clear-website-cache

        echo \"ğŸ”„ Restarting services...\"
        bench restart
      '

      echo 'âœ… Lodgeick deployment completed successfully!'
      echo 'ğŸŒ Site: https://lodgeick.com'
    "
