name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual deployment

env:
  SERVER_HOST: 77.37.87.141
  SERVER_USER: root
  BENCH_PATH: /home/frappe-user/frappe-bench
  SITE_NAME: lodgeick.com
  APP_NAME: lodgeick

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Production Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting Lodgeick deployment..."

            # Switch to frappe user and run deployment commands
            sudo -u frappe-user bash << 'EOF'
              set -e

              # Navigate to bench directory
              cd ${{ env.BENCH_PATH }}

              # Navigate to app directory
              cd apps/${{ env.APP_NAME }}

              echo "ðŸ“¦ Pulling latest code..."
              git fetch origin main
              git reset --hard origin/main
              git clean -fd

              echo "ðŸ“¦ Installing frontend dependencies..."
              cd frontend
              yarn install --frozen-lockfile || yarn install

              echo "ðŸ”¨ Building frontend..."
              yarn build

              echo "ðŸ”¨ Building backend assets..."
              cd ${{ env.BENCH_PATH }}
              bench build --app ${{ env.APP_NAME }}

              echo "ðŸ—ƒï¸ Running migrations..."
              bench --site ${{ env.SITE_NAME }} migrate || echo "âš ï¸ Migration failed or not needed"

              echo "ðŸ§¹ Clearing cache..."
              bench --site ${{ env.SITE_NAME }} clear-cache
              bench --site ${{ env.SITE_NAME }} clear-website-cache

              echo "ðŸ”„ Restarting services..."
              bench restart

              echo "âœ… Deployment completed successfully!"
              echo "ðŸŒ Site: https://${{ env.SITE_NAME }}"
          EOF
          ENDSSH

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 15

          # Check if site is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.SITE_NAME }} || echo "000")

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Site is accessible (HTTP $HTTP_CODE)"
            echo "ðŸŒ URL: https://${{ env.SITE_NAME }}"
          else
            echo "âŒ Site returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ env.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Site:** https://${{ env.SITE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
