name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SERVER_HOST: 77.37.87.141
  SERVER_USER: root
  BENCH_PATH: /home/frappe-user/frappe-bench
  SITE_NAME: lodgeick.com
  APP_NAME: lodgeick

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Production Server
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ env.SERVER_HOST }} "
            set -e
            echo 'ðŸš€ Starting Lodgeick deployment...'

            git config --global --add safe.directory ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }}

            sudo -u frappe-user GIT_SSH_COMMAND=\"ssh -i ~/.ssh/id_ed25519_benja_repo -F /dev/null\" bash -c '
              cd ${{ env.BENCH_PATH }}/apps/${{ env.APP_NAME }}

              echo \"ðŸ“¥ Pulling latest code...\"
              git fetch origin main
              git reset --hard origin/main
              git clean -fd

              echo \"ðŸ“¦ Installing frontend dependencies...\"
              cd frontend
              yarn install --frozen-lockfile || yarn install

              echo \"ðŸ”¨ Building frontend...\"
              yarn build

              echo \"ðŸ”¨ Building backend assets...\"
              cd ${{ env.BENCH_PATH }}
              bench build --app ${{ env.APP_NAME }}

              echo \"ðŸ—„ï¸ Migrating database...\"
              bench --site ${{ env.SITE_NAME }} migrate

              echo \"ðŸ§¹ Clearing cache...\"
              bench --site ${{ env.SITE_NAME }} clear-cache
              bench --site ${{ env.SITE_NAME }} clear-website-cache

              echo \"ðŸ”„ Restarting bench services...\"
              bench restart
            '

            echo \"ðŸ” Reloading nginx and supervisor...\"
            systemctl reload nginx
            supervisorctl reread
            supervisorctl update
            supervisorctl restart all || echo 'Supervisor restart failed, check manually.'

            echo 'âœ… Lodgeick deployment completed successfully!'
            echo 'ðŸŒ Site: https://${{ env.SITE_NAME }}'
          "

      - name: Verify Deployment
        run: |
          echo 'ðŸ” Verifying deployment...'
          sleep 10
          curl -f -s -o /dev/null https://${{ env.SITE_NAME }} || {
            echo 'âŒ Site not accessible'
            exit 1
          }
          echo 'âœ… Site is accessible at https://${{ env.SITE_NAME }}'

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ env.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Site:** https://${{ env.SITE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
