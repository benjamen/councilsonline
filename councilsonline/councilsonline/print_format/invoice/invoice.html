{% set request = frappe.get_doc("Request", doc.request) if doc.doctype == "Payment" else doc %}
{% set council = frappe.get_doc("Council", request.council) %}

<div class="invoice-wrapper">
	<style>
		.invoice-wrapper {
			font-family: Arial, sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
		}

		.invoice-header {
			display: flex;
			justify-content: space-between;
			align-items: start;
			margin-bottom: 30px;
			padding-bottom: 20px;
			border-bottom: 3px solid #333;
		}

		.council-info {
			flex: 1;
		}

		.council-logo {
			max-width: 150px;
			max-height: 80px;
		}

		.invoice-title {
			text-align: right;
			flex: 1;
		}

		.invoice-title h1 {
			margin: 0;
			color: #333;
			font-size: 32px;
		}

		.invoice-details {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-bottom: 30px;
		}

		.invoice-details .section {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 5px;
		}

		.invoice-details .section h3 {
			margin-top: 0;
			color: #555;
			font-size: 14px;
			text-transform: uppercase;
			border-bottom: 2px solid #ddd;
			padding-bottom: 8px;
		}

		.invoice-details .section p {
			margin: 5px 0;
			font-size: 13px;
		}

		.invoice-details .section strong {
			display: inline-block;
			width: 120px;
		}

		.fee-table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 20px;
		}

		.fee-table th {
			background: #333;
			color: white;
			padding: 12px;
			text-align: left;
			font-weight: 600;
		}

		.fee-table td {
			padding: 10px 12px;
			border-bottom: 1px solid #ddd;
		}

		.fee-table tr:hover {
			background: #f8f9fa;
		}

		.fee-table .text-right {
			text-align: right;
		}

		.totals {
			margin-left: auto;
			width: 300px;
			margin-top: 20px;
		}

		.totals table {
			width: 100%;
			border-collapse: collapse;
		}

		.totals td {
			padding: 8px;
			border-bottom: 1px solid #ddd;
		}

		.totals .total-row {
			font-weight: bold;
			font-size: 16px;
			background: #f8f9fa;
		}

		.totals .total-row td {
			border-top: 2px solid #333;
			border-bottom: 3px double #333;
		}

		.payment-info {
			background: #e7f3ff;
			padding: 15px;
			border-left: 4px solid #007bff;
			margin-top: 30px;
		}

		.payment-info h3 {
			margin-top: 0;
			color: #007bff;
		}

		.footer {
			margin-top: 40px;
			padding-top: 20px;
			border-top: 2px solid #ddd;
			text-align: center;
			font-size: 12px;
			color: #666;
		}

		@media print {
			.invoice-wrapper {
				padding: 0;
			}
		}
	</style>

	<!-- Header -->
	<div class="invoice-header">
		<div class="council-info">
			{% if council.logo %}
			<img src="{{ council.logo }}" alt="{{ council.council_name }}" class="council-logo">
			{% endif %}
			<h2>{{ council.council_name }}</h2>
			<p>{{ council.address or "" }}</p>
			<p>Email: {{ council.contact_email }}</p>
			<p>Phone: {{ council.contact_phone or "" }}</p>
		</div>
		<div class="invoice-title">
			<h1>INVOICE</h1>
			<p><strong>Date:</strong> {{ frappe.utils.format_date(frappe.utils.nowdate()) }}</p>
			{% if doc.doctype == "Payment" %}
			<p><strong>Invoice #:</strong> {{ doc.name }}</p>
			{% endif %}
		</div>
	</div>

	<!-- Invoice Details -->
	<div class="invoice-details">
		<div class="section">
			<h3>Bill To</h3>
			<p><strong>Name:</strong> {{ request.applicant_name or request.requester }}</p>
			<p><strong>Email:</strong> {{ request.applicant_email or frappe.db.get_value("User", request.requester, "email") }}</p>
			{% if request.applicant_phone %}
			<p><strong>Phone:</strong> {{ request.applicant_phone }}</p>
			{% endif %}
			{% if request.property_address %}
			<p><strong>Property:</strong> {{ request.property_address }}</p>
			{% endif %}
		</div>

		<div class="section">
			<h3>Application Details</h3>
			<p><strong>Request #:</strong> {{ request.name }}</p>
			<p><strong>Type:</strong> {{ request.request_type }}</p>
			<p><strong>Status:</strong> {{ request.status }}</p>
			<p><strong>Submitted:</strong> {{ frappe.utils.format_date(request.submitted_date) if request.submitted_date else "N/A" }}</p>
			{% if request.brief_description %}
			<p><strong>Description:</strong> {{ request.brief_description[:50] }}...</p>
			{% endif %}
		</div>
	</div>

	<!-- Fee Breakdown -->
	<table class="fee-table">
		<thead>
			<tr>
				<th>Description</th>
				<th>Fee Type</th>
				<th class="text-right">Amount (excl GST)</th>
			</tr>
		</thead>
		<tbody>
			{% if request.fees %}
				{% for fee in request.fees %}
				<tr>
					<td>{{ fee.description or fee.fee_type }}</td>
					<td>{{ fee.fee_type }}</td>
					<td class="text-right">${{ "%.2f"|format(fee.amount or 0) }}</td>
				</tr>
				{% endfor %}
			{% else %}
				<tr>
					<td colspan="3" style="text-align: center; color: #999;">No fees specified</td>
				</tr>
			{% endif %}
		</tbody>
	</table>

	<!-- Totals -->
	<div class="totals">
		<table>
			<tr>
				<td>Subtotal (excl GST):</td>
				<td class="text-right">${{ "%.2f"|format(request.total_fees_excl_gst or 0) }}</td>
			</tr>
			<tr>
				<td>GST (15%):</td>
				<td class="text-right">${{ "%.2f"|format(request.gst_amount or 0) }}</td>
			</tr>
			<tr class="total-row">
				<td>TOTAL (incl GST):</td>
				<td class="text-right">${{ "%.2f"|format(request.total_fees_incl_gst or 0) }}</td>
			</tr>
			{% if request.total_paid and request.total_paid > 0 %}
			<tr>
				<td>Amount Paid:</td>
				<td class="text-right" style="color: green;">${{ "%.2f"|format(request.total_paid) }}</td>
			</tr>
			<tr class="total-row">
				<td>OUTSTANDING:</td>
				<td class="text-right" style="color: #dc3545;">${{ "%.2f"|format((request.total_fees_incl_gst or 0) - (request.total_paid or 0)) }}</td>
			</tr>
			{% endif %}
		</table>
	</div>

	<!-- Payment Information -->
	<div class="payment-info">
		<h3>Payment Information</h3>
		{% if doc.doctype == "Payment" and doc.payment_status == "Completed" %}
			<p><strong>✓ Payment Received</strong></p>
			<p><strong>Payment Method:</strong> {{ doc.payment_method }}</p>
			<p><strong>Payment Date:</strong> {{ frappe.utils.format_date(doc.payment_date) }}</p>
			<p><strong>Transaction ID:</strong> {{ doc.stripe_payment_intent_id or doc.name }}</p>
			{% if doc.stripe_receipt_url %}
			<p><a href="{{ doc.stripe_receipt_url }}" target="_blank">View Stripe Receipt →</a></p>
			{% endif %}
		{% else %}
			<p><strong>Payment Status:</strong> {{ request.payment_status or "Pending" }}</p>
			<p>Payment can be made via:</p>
			<ul style="margin: 10px 0; padding-left: 20px;">
				<li>Credit Card (online portal)</li>
				<li>Bank Transfer to: <strong>{{ council.bank_account or "Contact council for details" }}</strong></li>
				<li>In person at council office</li>
			</ul>
			<p style="margin-top: 15px;"><strong>Reference:</strong> {{ request.name }}</p>
			<p style="font-size: 12px; color: #666;">Please include the request number as your payment reference.</p>
		{% endif %}
	</div>

	<!-- Footer -->
	<div class="footer">
		<p>{{ council.council_name }} | {{ council.contact_email }}</p>
		<p style="margin-top: 10px; font-size: 11px;">
			This is a computer-generated invoice. For queries, please contact us at {{ council.contact_email }}
		</p>
		<p style="margin-top: 5px; font-size: 11px;">
			Generated on {{ frappe.utils.format_datetime(frappe.utils.now()) }}
		</p>
	</div>
</div>
